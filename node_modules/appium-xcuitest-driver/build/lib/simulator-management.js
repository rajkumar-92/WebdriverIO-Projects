"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createSim = createSim;
exports.getExistingSim = getExistingSim;
exports.installToSimulator = installToSimulator;
exports.runSimulatorReset = runSimulatorReset;
exports.setLocale = setLocale;
exports.setLocaleAndPreferences = setLocaleAndPreferences;
exports.setPreferences = setPreferences;
exports.shutdownOtherSimulators = shutdownOtherSimulators;
exports.shutdownSimulator = shutdownSimulator;
require("source-map-support/register");
var _appiumIosSimulator = require("appium-ios-simulator");
var _nodeSimctl = _interopRequireDefault(require("node-simctl"));
var _appiumWebdriveragent = require("appium-webdriveragent");
var _lodash = _interopRequireDefault(require("lodash"));
var _logger = _interopRequireDefault(require("./logger"));
var _support = require("appium/support");
var _desiredCaps = require("./desired-caps");
const APPIUM_SIM_PREFIX = 'appiumTest';
const SETTINGS_CAPS = ['locationServicesEnabled', 'locationServicesAuthorized'];
const SAFARI_SETTINGS_CAPS = ['safariAllowPopups', 'safariIgnoreFraudWarning', 'safariOpenLinksInBackground'];

async function createSim(caps, platform = _desiredCaps.PLATFORM_NAME_IOS) {
  const devicesSetPath = caps.simulatorDevicesSetPath;
  const udid = await new _nodeSimctl.default({
    devicesSetPath
  }).createDevice(`${APPIUM_SIM_PREFIX}-${_support.util.uuidV4().toUpperCase()}-${caps.deviceName}`, caps.deviceName, caps.platformVersion, {
    platform
  });
  return await (0, _appiumIosSimulator.getSimulator)(udid, {
    platform,
    checkExistence: false,
    devicesSetPath
  });
}

async function getExistingSim(opts = {}) {
  const {
    platformVersion,
    deviceName,
    simulatorDevicesSetPath: devicesSetPath
  } = opts;
  let appiumTestDevice;
  const simctl = new _nodeSimctl.default({
    devicesSetPath
  });
  for (const device of _lodash.default.values(await simctl.getDevices(platformVersion))) {
    if (deviceName && device.name === deviceName || !deviceName) {
      return await (0, _appiumIosSimulator.getSimulator)(device.udid, {
        platform: device.platform,
        checkExistence: false,
        devicesSetPath
      });
    }
    if (device.name.startsWith(APPIUM_SIM_PREFIX) && (deviceName && device.name.endsWith(deviceName) || !deviceName)) {
      appiumTestDevice = device;
      if (device.state === 'Booted') {
        break;
      }
    }
  }
  if (appiumTestDevice) {
    _logger.default.warn(`Unable to find device '${deviceName}'. ` + `Found '${appiumTestDevice.name}' (udid: '${appiumTestDevice.udid}') instead`);
    return await (0, _appiumIosSimulator.getSimulator)(appiumTestDevice.udid, {
      platform: appiumTestDevice.platform,
      checkExistence: false,
      devicesSetPath
    });
  }
  return null;
}
async function shutdownSimulator(device) {
  await (0, _appiumWebdriveragent.resetTestProcesses)(device.udid, true);
  await device.shutdown();
}
async function runSimulatorReset(device, opts) {
  if (opts.noReset && !opts.fullReset) {
    _logger.default.debug('Reset: noReset is on. Leaving simulator as is');
    return;
  }
  if (!device) {
    _logger.default.debug('Reset: no device available. Skipping');
    return;
  }
  if (opts.fullReset) {
    _logger.default.debug('Reset: fullReset is on. Cleaning simulator');
    await shutdownSimulator(device);
    let isKeychainsBackupSuccessful = false;
    if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      isKeychainsBackupSuccessful = await device.backupKeychains();
    }
    await device.clean();
    if (isKeychainsBackupSuccessful) {
      await device.restoreKeychains(opts.keychainsExcludePatterns || []);
      _logger.default.info(`Successfully restored keychains after full reset`);
    } else if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      _logger.default.warn('Cannot restore keychains after full reset, because ' + 'the backup operation did not succeed');
    }
  } else if (opts.bundleId) {

    if (await device.isRunning()) {
      if (opts.enforceSimulatorShutdown) {
        await shutdownSimulator(device);
      } else {
        try {
          await device.simctl.terminateApp(opts.bundleId);
        } catch (err) {
          _logger.default.warn(`Reset: failed to terminate Simulator application with id "${opts.bundleId}"`);
        }
      }
    }
    if (opts.app) {
      _logger.default.info('Not scrubbing third party app in anticipation of uninstall');
      return;
    }
    const isSafari = (opts.browserName || '').toLowerCase() === 'safari';
    try {
      if (isSafari) {
        await device.cleanSafari();
      } else {
        await device.scrubCustomApp('', opts.bundleId);
      }
    } catch (err) {
      _logger.default.warn(err.message);
      _logger.default.warn(`Reset: could not scrub ${isSafari ? 'Safari browser' : 'application with id "' + opts.bundleId + '"'}. Leaving as is.`);
    }
  }
}

async function installToSimulator(device, app, bundleId, opts = {}) {
  if (!app) {
    _logger.default.debug('No app path is given. Nothing to install.');
    return;
  }
  const {
    noReset = true,
    newSimulator = false
  } = opts;
  if (!newSimulator && bundleId && (await device.isAppInstalled(bundleId))) {
    if (noReset) {
      _logger.default.debug(`App '${bundleId}' is already installed. No need to reinstall.`);
      return;
    }
    _logger.default.debug(`Reset requested. Removing app with id '${bundleId}' from the device`);
    await device.removeApp(bundleId);
  }
  _logger.default.debug(`Installing '${app}' on Simulator with UUID '${device.udid}'...`);
  try {
    await device.installApp(app);
  } catch (e) {
    _logger.default.info(`Got an error on '${app}' install: ${e.message}`);
    _logger.default.info('Retrying application install');
    await device.installApp(app);
  }
  _logger.default.debug('The app has been installed successfully.');
}
async function shutdownOtherSimulators(currentDevice) {
  const simctl = new _nodeSimctl.default({
    devicesSetPath: currentDevice.devicesSetPath
  });
  const allDevices = _lodash.default.flatMap(_lodash.default.values(await simctl.getDevices()));
  const otherBootedDevices = allDevices.filter(device => device.udid !== currentDevice.udid && device.state === 'Booted');
  if (_lodash.default.isEmpty(otherBootedDevices)) {
    _logger.default.info('No other running simulators have been detected');
    return;
  }
  _logger.default.info(`Detected ${otherBootedDevices.length} other running ${_support.util.pluralize('Simulator', otherBootedDevices.length)}.` + `Shutting them down...`);
  for (const {
    udid
  } of otherBootedDevices) {
    await (0, _appiumWebdriveragent.resetTestProcesses)(udid, true);
    simctl.udid = udid;
    await simctl.shutdownDevice();
  }
}
async function launchAndQuitSimulator(sim, opts = {}) {
  _logger.default.debug('No simulator directories found.');
  const {
    safari,
    timeout
  } = opts;
  return timeout ? await sim.launchAndQuit(safari, timeout) : await sim.launchAndQuit(safari);
}
function checkPreferences(settings, opts = {}) {
  for (let setting of settings) {
    if (_lodash.default.has(opts, setting)) {
      return true;
    }
  }
  return false;
}
async function setLocaleAndPreferences(sim, opts, safari = false, shutdownFn = _lodash.default.noop) {
  const localConfig = await setLocale(sim, opts, {}, safari);
  const prefsUpdated = await setPreferences(sim, opts, safari);
  if (localConfig._updated || prefsUpdated) {
    _logger.default.debug('Updated settings. Rebooting the simulator if it is already open');
    await shutdownFn(sim);
  } else {
    _logger.default.debug('Setting did not need to be updated');
  }
  delete localConfig._updated;
  return localConfig;
}

async function setLocale(sim, opts, localeConfig = {}, safari = false) {
  if (!opts.language && !opts.locale && !opts.calendarFormat) {
    _logger.default.debug('No reason to set locale');
    return {
      _updated: false
    };
  }

  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, {
      safari,
      timeout: opts.simulatorStartupTimeout
    });
  }
  _logger.default.debug('Setting locale information');
  localeConfig = {
    language: opts.language || localeConfig.language,
    locale: opts.locale || localeConfig.locale,
    calendarFormat: opts.calendarFormat || localeConfig.calendarFormat,
    _updated: false
  };
  try {
    let updated = await sim.updateLocale(opts.language, opts.locale, opts.calendarFormat);
    if (updated) {
      localeConfig._updated = true;
    }
  } catch (e) {
    _logger.default.errorAndThrow(`Appium was unable to set locale info: ${e}`);
  }
  return localeConfig;
}
async function setPreferences(sim, opts, safari = false) {
  let needToSetPrefs = checkPreferences(SETTINGS_CAPS, opts);
  let needToSetSafariPrefs = checkPreferences(SAFARI_SETTINGS_CAPS, opts);
  if (!needToSetPrefs && !needToSetSafariPrefs) {
    _logger.default.debug('No iOS / app preferences to set');
    return false;
  }
  _logger.default.debug('Setting iOS and app preferences');
  if (await sim.isFresh()) {
    await launchAndQuitSimulator(sim, {
      safari,
      timeout: opts.simulatorStartupTimeout
    });
  }
  let updated = false;
  try {
    if (needToSetPrefs) {
      updated = await setLocServicesPrefs(sim, opts);
    }
  } catch (e) {
    _logger.default.error('Error setting location services preferences, prefs will not work');
    _logger.default.error(e);
  }
  try {
    if (needToSetSafariPrefs) {
      updated = (await setSafariPrefs(sim, opts)) || updated;
    }
  } catch (e) {
    _logger.default.error('Error setting safari preferences, prefs will not work');
    _logger.default.error(e);
  }
  return updated;
}
async function setLocServicesPrefs(sim, opts = {}) {
  let locServ = _lodash.default.find([opts.locationServicesEnabled, opts.locationServicesAuthorized], c => !_lodash.default.isUndefined(c));
  if (!_lodash.default.isUndefined(locServ)) {
    locServ = locServ ? 1 : 0;
    _logger.default.debug(`Setting location services to ${locServ}`);
    await sim.updateSettings('locationServices', {
      LocationServicesEnabled: locServ,
      'LocationServicesEnabledIn7.0': locServ,
      'LocationServicesEnabledIn8.0': locServ
    });
  }
  if (!_lodash.default.isUndefined(opts.locationServicesAuthorized)) {
    if (!opts.bundleId) {
      let msg = "Can't set location services for app without bundle ID";
      _logger.default.errorAndThrow(msg);
    }
    let locAuth = !!opts.locationServicesAuthorized;
    if (locAuth) {
      _logger.default.debug('Authorizing location services for app');
    } else {
      _logger.default.debug('De-authorizing location services for app');
    }
    await sim.updateLocationSettings(opts.bundleId, locAuth);
  }
}
async function setSafariPrefs(sim, opts = {}) {
  let safariSettings = {};
  if (_lodash.default.has(opts, 'safariAllowPopups')) {
    const val = !!opts.safariAllowPopups;
    _logger.default.debug(`Setting javascript window opening to '${val}'`);
    safariSettings.WebKitJavaScriptCanOpenWindowsAutomatically = val;
    safariSettings.JavaScriptCanOpenWindowsAutomatically = val;
  }
  if (_lodash.default.has(opts, 'safariIgnoreFraudWarning')) {
    const val = !opts.safariIgnoreFraudWarning;
    _logger.default.debug(`Setting fraudulent website warning to '${val}'`);
    safariSettings.WarnAboutFraudulentWebsites = val;
  }
  if (_lodash.default.has(opts, 'safariOpenLinksInBackground')) {
    const val = opts.safariOpenLinksInBackground ? 1 : 0;
    _logger.default.debug(`Setting opening links in background to '${!!val}'`);
    safariSettings.OpenLinksInBackground = val;
  }
  return _lodash.default.size(safariSettings) > 0 ? await sim.updateSafariSettings(safariSettings) : false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJBUFBJVU1fU0lNX1BSRUZJWCIsIlNFVFRJTkdTX0NBUFMiLCJTQUZBUklfU0VUVElOR1NfQ0FQUyIsImNyZWF0ZVNpbSIsImNhcHMiLCJwbGF0Zm9ybSIsIlBMQVRGT1JNX05BTUVfSU9TIiwiZGV2aWNlc1NldFBhdGgiLCJzaW11bGF0b3JEZXZpY2VzU2V0UGF0aCIsInVkaWQiLCJTaW1jdGwiLCJjcmVhdGVEZXZpY2UiLCJ1dGlsIiwidXVpZFY0IiwidG9VcHBlckNhc2UiLCJkZXZpY2VOYW1lIiwicGxhdGZvcm1WZXJzaW9uIiwiZ2V0U2ltdWxhdG9yIiwiY2hlY2tFeGlzdGVuY2UiLCJnZXRFeGlzdGluZ1NpbSIsIm9wdHMiLCJhcHBpdW1UZXN0RGV2aWNlIiwic2ltY3RsIiwiZGV2aWNlIiwiXyIsInZhbHVlcyIsImdldERldmljZXMiLCJuYW1lIiwic3RhcnRzV2l0aCIsImVuZHNXaXRoIiwic3RhdGUiLCJsb2ciLCJ3YXJuIiwic2h1dGRvd25TaW11bGF0b3IiLCJyZXNldFRlc3RQcm9jZXNzZXMiLCJzaHV0ZG93biIsInJ1blNpbXVsYXRvclJlc2V0Iiwibm9SZXNldCIsImZ1bGxSZXNldCIsImRlYnVnIiwiaXNLZXljaGFpbnNCYWNrdXBTdWNjZXNzZnVsIiwia2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIiwia2VlcEtleUNoYWlucyIsImJhY2t1cEtleWNoYWlucyIsImNsZWFuIiwicmVzdG9yZUtleWNoYWlucyIsImluZm8iLCJidW5kbGVJZCIsImlzUnVubmluZyIsImVuZm9yY2VTaW11bGF0b3JTaHV0ZG93biIsInRlcm1pbmF0ZUFwcCIsImVyciIsImFwcCIsImlzU2FmYXJpIiwiYnJvd3Nlck5hbWUiLCJ0b0xvd2VyQ2FzZSIsImNsZWFuU2FmYXJpIiwic2NydWJDdXN0b21BcHAiLCJtZXNzYWdlIiwiaW5zdGFsbFRvU2ltdWxhdG9yIiwibmV3U2ltdWxhdG9yIiwiaXNBcHBJbnN0YWxsZWQiLCJyZW1vdmVBcHAiLCJpbnN0YWxsQXBwIiwiZSIsInNodXRkb3duT3RoZXJTaW11bGF0b3JzIiwiY3VycmVudERldmljZSIsImFsbERldmljZXMiLCJmbGF0TWFwIiwib3RoZXJCb290ZWREZXZpY2VzIiwiZmlsdGVyIiwiaXNFbXB0eSIsImxlbmd0aCIsInBsdXJhbGl6ZSIsInNodXRkb3duRGV2aWNlIiwibGF1bmNoQW5kUXVpdFNpbXVsYXRvciIsInNpbSIsInNhZmFyaSIsInRpbWVvdXQiLCJsYXVuY2hBbmRRdWl0IiwiY2hlY2tQcmVmZXJlbmNlcyIsInNldHRpbmdzIiwic2V0dGluZyIsImhhcyIsInNldExvY2FsZUFuZFByZWZlcmVuY2VzIiwic2h1dGRvd25GbiIsIm5vb3AiLCJsb2NhbENvbmZpZyIsInNldExvY2FsZSIsInByZWZzVXBkYXRlZCIsInNldFByZWZlcmVuY2VzIiwiX3VwZGF0ZWQiLCJsb2NhbGVDb25maWciLCJsYW5ndWFnZSIsImxvY2FsZSIsImNhbGVuZGFyRm9ybWF0IiwiaXNGcmVzaCIsInNpbXVsYXRvclN0YXJ0dXBUaW1lb3V0IiwidXBkYXRlZCIsInVwZGF0ZUxvY2FsZSIsImVycm9yQW5kVGhyb3ciLCJuZWVkVG9TZXRQcmVmcyIsIm5lZWRUb1NldFNhZmFyaVByZWZzIiwic2V0TG9jU2VydmljZXNQcmVmcyIsImVycm9yIiwic2V0U2FmYXJpUHJlZnMiLCJsb2NTZXJ2IiwiZmluZCIsImxvY2F0aW9uU2VydmljZXNFbmFibGVkIiwibG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWQiLCJjIiwiaXNVbmRlZmluZWQiLCJ1cGRhdGVTZXR0aW5ncyIsIkxvY2F0aW9uU2VydmljZXNFbmFibGVkIiwibXNnIiwibG9jQXV0aCIsInVwZGF0ZUxvY2F0aW9uU2V0dGluZ3MiLCJzYWZhcmlTZXR0aW5ncyIsInZhbCIsInNhZmFyaUFsbG93UG9wdXBzIiwiV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSIsIkphdmFTY3JpcHRDYW5PcGVuV2luZG93c0F1dG9tYXRpY2FsbHkiLCJzYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmciLCJXYXJuQWJvdXRGcmF1ZHVsZW50V2Vic2l0ZXMiLCJzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQiLCJPcGVuTGlua3NJbkJhY2tncm91bmQiLCJzaXplIiwidXBkYXRlU2FmYXJpU2V0dGluZ3MiXSwic291cmNlcyI6WyIuLi8uLi9saWIvc2ltdWxhdG9yLW1hbmFnZW1lbnQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0U2ltdWxhdG9yIH0gZnJvbSAnYXBwaXVtLWlvcy1zaW11bGF0b3InO1xuaW1wb3J0IFNpbWN0bCBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyByZXNldFRlc3RQcm9jZXNzZXMgfSBmcm9tICdhcHBpdW0td2ViZHJpdmVyYWdlbnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IFBMQVRGT1JNX05BTUVfSU9TIH0gZnJvbSAnLi9kZXNpcmVkLWNhcHMnO1xuXG5cbmNvbnN0IEFQUElVTV9TSU1fUFJFRklYID0gJ2FwcGl1bVRlc3QnO1xuY29uc3QgU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ2xvY2F0aW9uU2VydmljZXNFbmFibGVkJyxcbiAgJ2xvY2F0aW9uU2VydmljZXNBdXRob3JpemVkJyxcbl07XG5jb25zdCBTQUZBUklfU0VUVElOR1NfQ0FQUyA9IFtcbiAgJ3NhZmFyaUFsbG93UG9wdXBzJyxcbiAgJ3NhZmFyaUlnbm9yZUZyYXVkV2FybmluZycsXG4gICdzYWZhcmlPcGVuTGlua3NJbkJhY2tncm91bmQnLFxuXTtcblxuLyoqXG4gKiBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXJcbiAqXG4gKiBAcHJvcGVydHkge3N0cmluZ30gZGV2aWNlTmFtZSAtIEEgbmFtZSBmb3IgdGhlIGRldmljZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSB2ZXJzaW9uIG9mIGlPUyB0byB1c2VcbiAqL1xuLyoqXG4gKiBDcmVhdGUgYSBuZXcgc2ltdWxhdG9yIHdpdGggYGFwcGl1bVRlc3QtYCBwcmVmaXggYW5kIHJldHVybiB0aGUgb2JqZWN0LlxuICpcbiAqIEBwYXJhbSB7b2JqZWN0fSBTaW1DcmVhdGlvbkNhcHMgLSBDYXBhYmlsaXR5IHNldCBieSBhIHVzZXIuIFRoZSBvcHRpb25zIGF2YWlsYWJsZSBhcmU6XG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGxhdGZvcm0gW2lPU10gLSBQbGF0Zm9ybSBuYW1lIGluIG9yZGVyIHRvIHNwZWNpZnkgcnVudGltZSBzdWNoIGFzICdpT1MnLCAndHZPUycsICd3YXRjaE9TJ1xuICogQHJldHVybnMge29iamVjdH0gU2ltdWxhdG9yIG9iamVjdCBhc3NvY2lhdGVkIHdpdGggdGhlIHVkaWQgcGFzc2VkIGluLlxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVTaW0gKGNhcHMsIHBsYXRmb3JtID0gUExBVEZPUk1fTkFNRV9JT1MpIHtcbiAgY29uc3QgZGV2aWNlc1NldFBhdGggPSBjYXBzLnNpbXVsYXRvckRldmljZXNTZXRQYXRoO1xuICBjb25zdCB1ZGlkID0gYXdhaXQgbmV3IFNpbWN0bCh7ZGV2aWNlc1NldFBhdGh9KS5jcmVhdGVEZXZpY2UoXG4gICAgYCR7QVBQSVVNX1NJTV9QUkVGSVh9LSR7dXRpbC51dWlkVjQoKS50b1VwcGVyQ2FzZSgpfS0ke2NhcHMuZGV2aWNlTmFtZX1gLFxuICAgIGNhcHMuZGV2aWNlTmFtZSxcbiAgICBjYXBzLnBsYXRmb3JtVmVyc2lvbixcbiAgICB7cGxhdGZvcm19LFxuICApO1xuICByZXR1cm4gYXdhaXQgZ2V0U2ltdWxhdG9yKHVkaWQsIHtcbiAgICBwbGF0Zm9ybSxcbiAgICBjaGVja0V4aXN0ZW5jZTogZmFsc2UsXG4gICAgZGV2aWNlc1NldFBhdGgsXG4gIH0pO1xufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFNpbXVsYXRvckxvb2t1cE9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nP30gZGV2aWNlTmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBkZXZpY2UgdG8gbG9va3VwXG4gKiBAcHJvcGVydHkge3N0cmluZyF9IHBsYXRmb3JtVmVyc2lvbiAtIFRoZSBwbGF0Zm9ybSB2ZXJzaW9uIHN0cmluZ1xuICogQHByb3BlcnR5IHtzdHJpbmc/fSBzaW11bGF0b3JEZXZpY2VzU2V0UGF0aCAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIHNpbXVsYXRvciBkZXZpY2VzIHNldFxuICovXG5cbi8qKlxuICogR2V0IGEgc2ltdWxhdG9yIHdoaWNoIGlzIGFscmVhZHkgcnVubmluZy5cbiAqXG4gKiBAcGFyYW0ge1NpbXVsYXRvckxvb2t1cE9wdGlvbnM/fSBvcHRzXG4gKiBAcmV0dXJucyB7U2ltdWxhdG9yP30gVGhlIG1hdGNoZWQgU2ltdWxhdG9yIGluc3RhbmNlIG9yIGBudWxsYCBpZiBubyBtYXRjaGluZyAgZGV2aWNlIGlzIGZvdW5kLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRFeGlzdGluZ1NpbSAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICBwbGF0Zm9ybVZlcnNpb24sXG4gICAgZGV2aWNlTmFtZSxcbiAgICBzaW11bGF0b3JEZXZpY2VzU2V0UGF0aDogZGV2aWNlc1NldFBhdGgsXG4gIH0gPSBvcHRzO1xuXG4gIGxldCBhcHBpdW1UZXN0RGV2aWNlO1xuICBjb25zdCBzaW1jdGwgPSBuZXcgU2ltY3RsKHtkZXZpY2VzU2V0UGF0aH0pO1xuICBmb3IgKGNvbnN0IGRldmljZSBvZiBfLnZhbHVlcyhhd2FpdCBzaW1jdGwuZ2V0RGV2aWNlcyhwbGF0Zm9ybVZlcnNpb24pKSkge1xuICAgIGlmICgoZGV2aWNlTmFtZSAmJiBkZXZpY2UubmFtZSA9PT0gZGV2aWNlTmFtZSkgfHwgIWRldmljZU5hbWUpIHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRTaW11bGF0b3IoZGV2aWNlLnVkaWQsIHtcbiAgICAgICAgcGxhdGZvcm06IGRldmljZS5wbGF0Zm9ybSxcbiAgICAgICAgY2hlY2tFeGlzdGVuY2U6IGZhbHNlLFxuICAgICAgICBkZXZpY2VzU2V0UGF0aCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChkZXZpY2UubmFtZS5zdGFydHNXaXRoKEFQUElVTV9TSU1fUFJFRklYKVxuICAgICAgJiYgKChkZXZpY2VOYW1lICYmIGRldmljZS5uYW1lLmVuZHNXaXRoKGRldmljZU5hbWUpKSB8fCAhZGV2aWNlTmFtZSkpIHtcbiAgICAgIGFwcGl1bVRlc3REZXZpY2UgPSBkZXZpY2U7XG4gICAgICAvLyBjaG9vc2UgdGhlIGZpcnN0IGJvb3RlZCBzaW11bGF0b3JcbiAgICAgIGlmIChkZXZpY2Uuc3RhdGUgPT09ICdCb290ZWQnKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChhcHBpdW1UZXN0RGV2aWNlKSB7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byBmaW5kIGRldmljZSAnJHtkZXZpY2VOYW1lfScuIGAgK1xuICAgICAgYEZvdW5kICcke2FwcGl1bVRlc3REZXZpY2UubmFtZX0nICh1ZGlkOiAnJHthcHBpdW1UZXN0RGV2aWNlLnVkaWR9JykgaW5zdGVhZGApO1xuICAgIHJldHVybiBhd2FpdCBnZXRTaW11bGF0b3IoYXBwaXVtVGVzdERldmljZS51ZGlkLCB7XG4gICAgICBwbGF0Zm9ybTogYXBwaXVtVGVzdERldmljZS5wbGF0Zm9ybSxcbiAgICAgIGNoZWNrRXhpc3RlbmNlOiBmYWxzZSxcbiAgICAgIGRldmljZXNTZXRQYXRoLFxuICAgIH0pO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzaHV0ZG93blNpbXVsYXRvciAoZGV2aWNlKSB7XG4gIC8vIHN0b3AgWENUZXN0IHByb2Nlc3NlcyBpZiBydW5uaW5nIHRvIGF2b2lkIHVuZXhwZWN0ZWQgc2lkZSBlZmZlY3RzXG4gIGF3YWl0IHJlc2V0VGVzdFByb2Nlc3NlcyhkZXZpY2UudWRpZCwgdHJ1ZSk7XG4gIGF3YWl0IGRldmljZS5zaHV0ZG93bigpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW5TaW11bGF0b3JSZXNldCAoZGV2aWNlLCBvcHRzKSB7XG4gIGlmIChvcHRzLm5vUmVzZXQgJiYgIW9wdHMuZnVsbFJlc2V0KSB7XG4gICAgLy8gbm9SZXNldCA9PT0gdHJ1ZSAmJiBmdWxsUmVzZXQgPT09IGZhbHNlXG4gICAgbG9nLmRlYnVnKCdSZXNldDogbm9SZXNldCBpcyBvbi4gTGVhdmluZyBzaW11bGF0b3IgYXMgaXMnKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBpZiAoIWRldmljZSkge1xuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IG5vIGRldmljZSBhdmFpbGFibGUuIFNraXBwaW5nJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKG9wdHMuZnVsbFJlc2V0KSB7XG4gICAgbG9nLmRlYnVnKCdSZXNldDogZnVsbFJlc2V0IGlzIG9uLiBDbGVhbmluZyBzaW11bGF0b3InKTtcbiAgICBhd2FpdCBzaHV0ZG93blNpbXVsYXRvcihkZXZpY2UpO1xuICAgIGxldCBpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwgPSBmYWxzZTtcbiAgICBpZiAob3B0cy5rZXljaGFpbnNFeGNsdWRlUGF0dGVybnMgfHwgb3B0cy5rZWVwS2V5Q2hhaW5zKSB7XG4gICAgICBpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwgPSBhd2FpdCBkZXZpY2UuYmFja3VwS2V5Y2hhaW5zKCk7XG4gICAgfVxuICAgIGF3YWl0IGRldmljZS5jbGVhbigpO1xuICAgIGlmIChpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwpIHtcbiAgICAgIGF3YWl0IGRldmljZS5yZXN0b3JlS2V5Y2hhaW5zKG9wdHMua2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIHx8IFtdKTtcbiAgICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgcmVzdG9yZWQga2V5Y2hhaW5zIGFmdGVyIGZ1bGwgcmVzZXRgKTtcbiAgICB9IGVsc2UgaWYgKG9wdHMua2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIHx8IG9wdHMua2VlcEtleUNoYWlucykge1xuICAgICAgbG9nLndhcm4oJ0Nhbm5vdCByZXN0b3JlIGtleWNoYWlucyBhZnRlciBmdWxsIHJlc2V0LCBiZWNhdXNlICcgK1xuICAgICAgICAgICAgICAgJ3RoZSBiYWNrdXAgb3BlcmF0aW9uIGRpZCBub3Qgc3VjY2VlZCcpO1xuICAgIH1cbiAgfSBlbHNlIGlmIChvcHRzLmJ1bmRsZUlkKSB7XG4gICAgLy8gZmFzdFJlc2V0IG9yIG5vUmVzZXRcblxuICAgIC8vIFRlcm1pbmF0ZSB0aGUgYXBwIHVuZGVyIHRlc3QgaWYgaXQgaXMgc3RpbGwgcnVubmluZyBvbiBTaW11bGF0b3JcbiAgICAvLyBUZXJtaW5hdGlvbiBpcyBub3QgbmVlZGVkIGlmIFNpbXVsYXRvciBpcyBub3QgcnVubmluZ1xuICAgIGlmIChhd2FpdCBkZXZpY2UuaXNSdW5uaW5nKCkpIHtcbiAgICAgIGlmIChvcHRzLmVuZm9yY2VTaW11bGF0b3JTaHV0ZG93bikge1xuICAgICAgICBhd2FpdCBzaHV0ZG93blNpbXVsYXRvcihkZXZpY2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBkZXZpY2Uuc2ltY3RsLnRlcm1pbmF0ZUFwcChvcHRzLmJ1bmRsZUlkKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbG9nLndhcm4oYFJlc2V0OiBmYWlsZWQgdG8gdGVybWluYXRlIFNpbXVsYXRvciBhcHBsaWNhdGlvbiB3aXRoIGlkIFwiJHtvcHRzLmJ1bmRsZUlkfVwiYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG9wdHMuYXBwKSB7XG4gICAgICBsb2cuaW5mbygnTm90IHNjcnViYmluZyB0aGlyZCBwYXJ0eSBhcHAgaW4gYW50aWNpcGF0aW9uIG9mIHVuaW5zdGFsbCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpc1NhZmFyaSA9IChvcHRzLmJyb3dzZXJOYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpID09PSAnc2FmYXJpJztcbiAgICB0cnkge1xuICAgICAgaWYgKGlzU2FmYXJpKSB7XG4gICAgICAgIGF3YWl0IGRldmljZS5jbGVhblNhZmFyaSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gaU9TIDgrIGRvZXMgbm90IG5lZWQgYmFzZW5hbWVcbiAgICAgICAgYXdhaXQgZGV2aWNlLnNjcnViQ3VzdG9tQXBwKCcnLCBvcHRzLmJ1bmRsZUlkKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGVyci5tZXNzYWdlKTtcbiAgICAgIGxvZy53YXJuKGBSZXNldDogY291bGQgbm90IHNjcnViICR7aXNTYWZhcmkgPyAnU2FmYXJpIGJyb3dzZXInIDogJ2FwcGxpY2F0aW9uIHdpdGggaWQgXCInICsgb3B0cy5idW5kbGVJZCArICdcIid9LiBMZWF2aW5nIGFzIGlzLmApO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEluc3RhbGxPcHRpb25zXG4gKlxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gbm9SZXNldCBbZmFsc2VdIFdoZXRoZXIgdG8gZGlzYWJsZSByZXNldFxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gbmV3U2ltdWxhdG9yIFtmYWxzZV0gV2hldGhlciB0aGUgc2ltdWxhdG9yIGlzIGJyYW5kIG5ld1xuICovXG5cbi8qKlxuICogQHBhcmFtIHtvYmplY3R9IGRldmljZSBUaGUgc2ltdWxhdG9yIGRldmljZSBvYmplY3RcbiAqIEBwYXJhbSB7P3N0cmluZ30gYXBwIFRoZSBhcHAgdG8gdGhlIHBhdGhcbiAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCBUaGUgYnVuZGxlIGlkIHRvIGVuc3VyZSBpdCBpcyBhbHJlYWR5IGluc3RhbGxlZCBhbmQgdW5pbnN0YWxsIGl0XG4gKiBAcGFyYW0gez9JbnN0YWxsT3B0aW9uc30gb3B0c1xuICovXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsVG9TaW11bGF0b3IgKGRldmljZSwgYXBwLCBidW5kbGVJZCwgb3B0cyA9IHt9KSB7XG4gIGlmICghYXBwKSB7XG4gICAgbG9nLmRlYnVnKCdObyBhcHAgcGF0aCBpcyBnaXZlbi4gTm90aGluZyB0byBpbnN0YWxsLicpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICBub1Jlc2V0ID0gdHJ1ZSxcbiAgICBuZXdTaW11bGF0b3IgPSBmYWxzZSxcbiAgfSA9IG9wdHM7XG5cbiAgaWYgKCFuZXdTaW11bGF0b3IgJiYgYnVuZGxlSWQgJiYgYXdhaXQgZGV2aWNlLmlzQXBwSW5zdGFsbGVkKGJ1bmRsZUlkKSkge1xuICAgIGlmIChub1Jlc2V0KSB7XG4gICAgICBsb2cuZGVidWcoYEFwcCAnJHtidW5kbGVJZH0nIGlzIGFscmVhZHkgaW5zdGFsbGVkLiBObyBuZWVkIHRvIHJlaW5zdGFsbC5gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBSZXNldCByZXF1ZXN0ZWQuIFJlbW92aW5nIGFwcCB3aXRoIGlkICcke2J1bmRsZUlkfScgZnJvbSB0aGUgZGV2aWNlYCk7XG4gICAgYXdhaXQgZGV2aWNlLnJlbW92ZUFwcChidW5kbGVJZCk7XG4gIH1cblxuICBsb2cuZGVidWcoYEluc3RhbGxpbmcgJyR7YXBwfScgb24gU2ltdWxhdG9yIHdpdGggVVVJRCAnJHtkZXZpY2UudWRpZH0nLi4uYCk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZGV2aWNlLmluc3RhbGxBcHAoYXBwKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIGl0IHNvbWV0aW1lcyBmYWlscyBvbiBYY29kZSAxMCBiZWNhdXNlIG9mIGEgcmFjZSBjb25kaXRpb25cbiAgICBsb2cuaW5mbyhgR290IGFuIGVycm9yIG9uICcke2FwcH0nIGluc3RhbGw6ICR7ZS5tZXNzYWdlfWApO1xuICAgIGxvZy5pbmZvKCdSZXRyeWluZyBhcHBsaWNhdGlvbiBpbnN0YWxsJyk7XG4gICAgYXdhaXQgZGV2aWNlLmluc3RhbGxBcHAoYXBwKTtcbiAgfVxuICBsb2cuZGVidWcoJ1RoZSBhcHAgaGFzIGJlZW4gaW5zdGFsbGVkIHN1Y2Nlc3NmdWxseS4nKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2h1dGRvd25PdGhlclNpbXVsYXRvcnMgKGN1cnJlbnREZXZpY2UpIHtcbiAgY29uc3Qgc2ltY3RsID0gbmV3IFNpbWN0bCh7XG4gICAgZGV2aWNlc1NldFBhdGg6IGN1cnJlbnREZXZpY2UuZGV2aWNlc1NldFBhdGhcbiAgfSk7XG4gIGNvbnN0IGFsbERldmljZXMgPSBfLmZsYXRNYXAoXy52YWx1ZXMoYXdhaXQgc2ltY3RsLmdldERldmljZXMoKSkpO1xuICBjb25zdCBvdGhlckJvb3RlZERldmljZXMgPSBhbGxEZXZpY2VzLmZpbHRlcigoZGV2aWNlKSA9PiBkZXZpY2UudWRpZCAhPT0gY3VycmVudERldmljZS51ZGlkICYmIGRldmljZS5zdGF0ZSA9PT0gJ0Jvb3RlZCcpO1xuICBpZiAoXy5pc0VtcHR5KG90aGVyQm9vdGVkRGV2aWNlcykpIHtcbiAgICBsb2cuaW5mbygnTm8gb3RoZXIgcnVubmluZyBzaW11bGF0b3JzIGhhdmUgYmVlbiBkZXRlY3RlZCcpO1xuICAgIHJldHVybjtcbiAgfVxuICBsb2cuaW5mbyhgRGV0ZWN0ZWQgJHtvdGhlckJvb3RlZERldmljZXMubGVuZ3RofSBvdGhlciBydW5uaW5nICR7dXRpbC5wbHVyYWxpemUoJ1NpbXVsYXRvcicsIG90aGVyQm9vdGVkRGV2aWNlcy5sZW5ndGgpfS5gICtcbiAgICBgU2h1dHRpbmcgdGhlbSBkb3duLi4uYCk7XG4gIGZvciAoY29uc3Qge3VkaWR9IG9mIG90aGVyQm9vdGVkRGV2aWNlcykge1xuICAgIC8vIEl0IGlzIG5lY2Vzc2FyeSB0byBzdG9wIHRoZSBjb3JyZXNwb25kaW5nIHhjb2RlYnVpbGQgcHJvY2VzcyBiZWZvcmUga2lsbGluZ1xuICAgIC8vIHRoZSBzaW11bGF0b3IsIG90aGVyd2lzZSBpdCB3aWxsIGJlIGF1dG9tYXRpY2FsbHkgcmVzdGFydGVkXG4gICAgYXdhaXQgcmVzZXRUZXN0UHJvY2Vzc2VzKHVkaWQsIHRydWUpO1xuICAgIHNpbWN0bC51ZGlkID0gdWRpZDtcbiAgICBhd2FpdCBzaW1jdGwuc2h1dGRvd25EZXZpY2UoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yIChzaW0sIG9wdHMgPSB7fSkge1xuICBsb2cuZGVidWcoJ05vIHNpbXVsYXRvciBkaXJlY3RvcmllcyBmb3VuZC4nKTtcbiAgY29uc3QgeyBzYWZhcmksIHRpbWVvdXQgfSA9IG9wdHM7XG4gIHJldHVybiB0aW1lb3V0XG4gICAgPyBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdChzYWZhcmksIHRpbWVvdXQpXG4gICAgOiBhd2FpdCBzaW0ubGF1bmNoQW5kUXVpdChzYWZhcmkpO1xufVxuXG5mdW5jdGlvbiBjaGVja1ByZWZlcmVuY2VzIChzZXR0aW5ncywgb3B0cyA9IHt9KSB7XG4gIGZvciAobGV0IHNldHRpbmcgb2Ygc2V0dGluZ3MpIHtcbiAgICBpZiAoXy5oYXMob3B0cywgc2V0dGluZykpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldExvY2FsZUFuZFByZWZlcmVuY2VzIChzaW0sIG9wdHMsIHNhZmFyaSA9IGZhbHNlLCBzaHV0ZG93bkZuID0gXy5ub29wKSB7XG4gIGNvbnN0IGxvY2FsQ29uZmlnID0gYXdhaXQgc2V0TG9jYWxlKHNpbSwgb3B0cywge30sIHNhZmFyaSk7XG4gIGNvbnN0IHByZWZzVXBkYXRlZCA9IGF3YWl0IHNldFByZWZlcmVuY2VzKHNpbSwgb3B0cywgc2FmYXJpKTtcbiAgaWYgKGxvY2FsQ29uZmlnLl91cGRhdGVkIHx8IHByZWZzVXBkYXRlZCkge1xuICAgIGxvZy5kZWJ1ZygnVXBkYXRlZCBzZXR0aW5ncy4gUmVib290aW5nIHRoZSBzaW11bGF0b3IgaWYgaXQgaXMgYWxyZWFkeSBvcGVuJyk7XG4gICAgYXdhaXQgc2h1dGRvd25GbihzaW0pO1xuICB9IGVsc2Uge1xuICAgIGxvZy5kZWJ1ZygnU2V0dGluZyBkaWQgbm90IG5lZWQgdG8gYmUgdXBkYXRlZCcpO1xuICB9XG4gIGRlbGV0ZSBsb2NhbENvbmZpZy5fdXBkYXRlZDtcbiAgcmV0dXJuIGxvY2FsQ29uZmlnO1xufVxuXG4vLyBwYXNzIGluIHRoZSBzaW11bGF0b3Igc28gdGhhdCBvdGhlciBzeXN0ZW1zIHRoYXQgdXNlIHRoZSBmdW5jdGlvbiBjYW4gc3VwcGx5XG4vLyB3aGF0ZXZlciB0aGV5IGhhdmVcbmFzeW5jIGZ1bmN0aW9uIHNldExvY2FsZSAoc2ltLCBvcHRzLCBsb2NhbGVDb25maWcgPSB7fSwgc2FmYXJpID0gZmFsc2UpIHtcbiAgaWYgKCFvcHRzLmxhbmd1YWdlICYmICFvcHRzLmxvY2FsZSAmJiAhb3B0cy5jYWxlbmRhckZvcm1hdCkge1xuICAgIGxvZy5kZWJ1ZygnTm8gcmVhc29uIHRvIHNldCBsb2NhbGUnKTtcbiAgICByZXR1cm4ge1xuICAgICAgX3VwZGF0ZWQ6IGZhbHNlLFxuICAgIH07XG4gIH1cblxuICAvLyB3ZSBuZWVkIHRoZSBzaW11bGF0b3IgdG8gaGF2ZSBpdHMgZGlyZWN0b3JpZXMgaW4gcGxhY2VcbiAgaWYgKGF3YWl0IHNpbS5pc0ZyZXNoKCkpIHtcbiAgICBhd2FpdCBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yKHNpbSwge1xuICAgICAgc2FmYXJpLFxuICAgICAgdGltZW91dDogb3B0cy5zaW11bGF0b3JTdGFydHVwVGltZW91dCxcbiAgICB9KTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygnU2V0dGluZyBsb2NhbGUgaW5mb3JtYXRpb24nKTtcbiAgbG9jYWxlQ29uZmlnID0ge1xuICAgIGxhbmd1YWdlOiBvcHRzLmxhbmd1YWdlIHx8IGxvY2FsZUNvbmZpZy5sYW5ndWFnZSxcbiAgICBsb2NhbGU6IG9wdHMubG9jYWxlIHx8IGxvY2FsZUNvbmZpZy5sb2NhbGUsXG4gICAgY2FsZW5kYXJGb3JtYXQ6IG9wdHMuY2FsZW5kYXJGb3JtYXQgfHwgbG9jYWxlQ29uZmlnLmNhbGVuZGFyRm9ybWF0LFxuICAgIF91cGRhdGVkOiBmYWxzZSxcbiAgfTtcblxuICB0cnkge1xuICAgIGxldCB1cGRhdGVkID0gYXdhaXQgc2ltLnVwZGF0ZUxvY2FsZShvcHRzLmxhbmd1YWdlLCBvcHRzLmxvY2FsZSwgb3B0cy5jYWxlbmRhckZvcm1hdCk7XG4gICAgaWYgKHVwZGF0ZWQpIHtcbiAgICAgIGxvY2FsZUNvbmZpZy5fdXBkYXRlZCA9IHRydWU7XG4gICAgfVxuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEFwcGl1bSB3YXMgdW5hYmxlIHRvIHNldCBsb2NhbGUgaW5mbzogJHtlfWApO1xuICB9XG5cbiAgcmV0dXJuIGxvY2FsZUNvbmZpZztcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0UHJlZmVyZW5jZXMgKHNpbSwgb3B0cywgc2FmYXJpID0gZmFsc2UpIHtcbiAgbGV0IG5lZWRUb1NldFByZWZzID0gY2hlY2tQcmVmZXJlbmNlcyhTRVRUSU5HU19DQVBTLCBvcHRzKTtcbiAgbGV0IG5lZWRUb1NldFNhZmFyaVByZWZzID0gY2hlY2tQcmVmZXJlbmNlcyhTQUZBUklfU0VUVElOR1NfQ0FQUywgb3B0cyk7XG4gIGlmICghbmVlZFRvU2V0UHJlZnMgJiYgIW5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgbG9nLmRlYnVnKCdObyBpT1MgLyBhcHAgcHJlZmVyZW5jZXMgdG8gc2V0Jyk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdTZXR0aW5nIGlPUyBhbmQgYXBwIHByZWZlcmVuY2VzJyk7XG5cbiAgaWYgKGF3YWl0IHNpbS5pc0ZyZXNoKCkpIHtcbiAgICBhd2FpdCBsYXVuY2hBbmRRdWl0U2ltdWxhdG9yKHNpbSwge1xuICAgICAgc2FmYXJpLFxuICAgICAgdGltZW91dDogb3B0cy5zaW11bGF0b3JTdGFydHVwVGltZW91dCxcbiAgICB9KTtcbiAgfVxuXG4gIGxldCB1cGRhdGVkID0gZmFsc2U7XG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFByZWZzKSB7XG4gICAgICB1cGRhdGVkID0gYXdhaXQgc2V0TG9jU2VydmljZXNQcmVmcyhzaW0sIG9wdHMpO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvcignRXJyb3Igc2V0dGluZyBsb2NhdGlvbiBzZXJ2aWNlcyBwcmVmZXJlbmNlcywgcHJlZnMgd2lsbCBub3Qgd29yaycpO1xuICAgIGxvZy5lcnJvcihlKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgaWYgKG5lZWRUb1NldFNhZmFyaVByZWZzKSB7XG4gICAgICB1cGRhdGVkID0gYXdhaXQgc2V0U2FmYXJpUHJlZnMoc2ltLCBvcHRzKSB8fCB1cGRhdGVkO1xuICAgIH1cbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvcignRXJyb3Igc2V0dGluZyBzYWZhcmkgcHJlZmVyZW5jZXMsIHByZWZzIHdpbGwgbm90IHdvcmsnKTtcbiAgICBsb2cuZXJyb3IoZSk7XG4gIH1cblxuICByZXR1cm4gdXBkYXRlZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0TG9jU2VydmljZXNQcmVmcyAoc2ltLCBvcHRzID0ge30pIHtcbiAgbGV0IGxvY1NlcnYgPSBfLmZpbmQoW29wdHMubG9jYXRpb25TZXJ2aWNlc0VuYWJsZWQsIG9wdHMubG9jYXRpb25TZXJ2aWNlc0F1dGhvcml6ZWRdLCAoYykgPT4gIV8uaXNVbmRlZmluZWQoYykpO1xuICBpZiAoIV8uaXNVbmRlZmluZWQobG9jU2VydikpIHtcbiAgICBsb2NTZXJ2ID0gbG9jU2VydiA/IDEgOiAwO1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBsb2NhdGlvbiBzZXJ2aWNlcyB0byAke2xvY1NlcnZ9YCk7XG4gICAgYXdhaXQgc2ltLnVwZGF0ZVNldHRpbmdzKCdsb2NhdGlvblNlcnZpY2VzJywge1xuICAgICAgTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWQ6IGxvY1NlcnYsXG4gICAgICAnTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWRJbjcuMCc6IGxvY1NlcnYsXG4gICAgICAnTG9jYXRpb25TZXJ2aWNlc0VuYWJsZWRJbjguMCc6IGxvY1NlcnZcbiAgICB9KTtcbiAgfVxuICBpZiAoIV8uaXNVbmRlZmluZWQob3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZCkpIHtcbiAgICBpZiAoIW9wdHMuYnVuZGxlSWQpIHtcbiAgICAgIGxldCBtc2cgPSBcIkNhbid0IHNldCBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwIHdpdGhvdXQgYnVuZGxlIElEXCI7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhtc2cpO1xuICAgIH1cbiAgICBsZXQgbG9jQXV0aCA9ICEhb3B0cy5sb2NhdGlvblNlcnZpY2VzQXV0aG9yaXplZDtcbiAgICBpZiAobG9jQXV0aCkge1xuICAgICAgbG9nLmRlYnVnKCdBdXRob3JpemluZyBsb2NhdGlvbiBzZXJ2aWNlcyBmb3IgYXBwJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnRGUtYXV0aG9yaXppbmcgbG9jYXRpb24gc2VydmljZXMgZm9yIGFwcCcpO1xuICAgIH1cbiAgICBhd2FpdCBzaW0udXBkYXRlTG9jYXRpb25TZXR0aW5ncyhvcHRzLmJ1bmRsZUlkLCBsb2NBdXRoKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRTYWZhcmlQcmVmcyAoc2ltLCBvcHRzID0ge30pIHtcbiAgbGV0IHNhZmFyaVNldHRpbmdzID0ge307XG5cbiAgaWYgKF8uaGFzKG9wdHMsICdzYWZhcmlBbGxvd1BvcHVwcycpKSB7XG4gICAgY29uc3QgdmFsID0gISFvcHRzLnNhZmFyaUFsbG93UG9wdXBzO1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBqYXZhc2NyaXB0IHdpbmRvdyBvcGVuaW5nIHRvICcke3ZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuV2ViS2l0SmF2YVNjcmlwdENhbk9wZW5XaW5kb3dzQXV0b21hdGljYWxseSA9IHZhbDtcbiAgICBzYWZhcmlTZXR0aW5ncy5KYXZhU2NyaXB0Q2FuT3BlbldpbmRvd3NBdXRvbWF0aWNhbGx5ID0gdmFsO1xuICB9XG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpSWdub3JlRnJhdWRXYXJuaW5nJykpIHtcbiAgICBjb25zdCB2YWwgPSAhb3B0cy5zYWZhcmlJZ25vcmVGcmF1ZFdhcm5pbmc7XG4gICAgbG9nLmRlYnVnKGBTZXR0aW5nIGZyYXVkdWxlbnQgd2Vic2l0ZSB3YXJuaW5nIHRvICcke3ZhbH0nYCk7XG4gICAgc2FmYXJpU2V0dGluZ3MuV2FybkFib3V0RnJhdWR1bGVudFdlYnNpdGVzID0gdmFsO1xuICB9XG4gIGlmIChfLmhhcyhvcHRzLCAnc2FmYXJpT3BlbkxpbmtzSW5CYWNrZ3JvdW5kJykpIHtcbiAgICBjb25zdCB2YWwgPSBvcHRzLnNhZmFyaU9wZW5MaW5rc0luQmFja2dyb3VuZCA/IDEgOiAwO1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBvcGVuaW5nIGxpbmtzIGluIGJhY2tncm91bmQgdG8gJyR7ISF2YWx9J2ApO1xuICAgIHNhZmFyaVNldHRpbmdzLk9wZW5MaW5rc0luQmFja2dyb3VuZCA9IHZhbDtcbiAgfVxuICByZXR1cm4gKF8uc2l6ZShzYWZhcmlTZXR0aW5ncykgPiAwKVxuICAgID8gYXdhaXQgc2ltLnVwZGF0ZVNhZmFyaVNldHRpbmdzKHNhZmFyaVNldHRpbmdzKVxuICAgIDogZmFsc2U7XG59XG5cbmV4cG9ydCB7XG4gIGNyZWF0ZVNpbSwgZ2V0RXhpc3RpbmdTaW0sIHJ1blNpbXVsYXRvclJlc2V0LCBpbnN0YWxsVG9TaW11bGF0b3IsXG4gIHNodXRkb3duU2ltdWxhdG9yLCBzaHV0ZG93bk90aGVyU2ltdWxhdG9ycyxcbiAgc2V0TG9jYWxlLCBzZXRQcmVmZXJlbmNlcywgc2V0TG9jYWxlQW5kUHJlZmVyZW5jZXMsXG59O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFHQSxNQUFNQSxpQkFBaUIsR0FBRyxZQUFZO0FBQ3RDLE1B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