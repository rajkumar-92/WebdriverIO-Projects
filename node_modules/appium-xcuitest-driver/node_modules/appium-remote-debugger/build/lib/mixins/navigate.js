"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;
require("source-map-support/register");
var _logger = _interopRequireDefault(require("../logger"));
var _utils = require("../utils");
var _events = _interopRequireDefault(require("./events"));
var _support = require("appium/support");
var _lodash = _interopRequireDefault(require("lodash"));
var _bluebird = _interopRequireDefault(require("bluebird"));
function frameDetached() {
  this.emit(_events.default.EVENT_FRAMES_DETACHED);
}
async function pageLoad(startPageLoadTimer, pageLoadVerifyHook = _lodash.default.noop) {
  var _startPageLoadTimer;
  const timeoutMs = 500;
  if (!_lodash.default.isFunction((_startPageLoadTimer = startPageLoadTimer) === null || _startPageLoadTimer === void 0 ? void 0 : _startPageLoadTimer.getDuration)) {
    _logger.default.debug(`Page load timer not a timer. Creating new timer`);
    startPageLoadTimer = new _support.timing.Timer().start();
  }
  _logger.default.debug('Page loaded, verifying whether ready');
  this.pageLoading = true;
  const verify = async () => {
    this.pageLoadDelay = _support.util.cancellableDelay(timeoutMs);
    try {
      await this.pageLoadDelay;
    } catch (err) {
      if (err instanceof _bluebird.default.CancellationError) {
        return;
      }
    }

    if (!this.appIdKey) {
      _logger.default.debug('Not connected to an application. Ignoring page load');
      return;
    }
    if (_lodash.default.isFunction(pageLoadVerifyHook)) {
      await pageLoadVerifyHook();
    }

    const elapsedMs = startPageLoadTimer.getDuration().asMilliSeconds;
    if ((await this.checkPageIsReady()) || this.pageLoadMs > 0 && elapsedMs > this.pageLoadMs) {
      _logger.default.debug('Page is ready');
      this.pageLoading = false;
    } else {
      _logger.default.debug('Page was not ready, retrying');
      await verify();
    }
  };
  try {
    await verify();
  } finally {
    _logger.default.debug(`Page load completed in ${startPageLoadTimer.getDuration().asMilliSeconds.toFixed(0)}ms`);
    this.pageLoading = false;
  }
}
function cancelPageLoad() {
  _logger.default.debug('Unregistering from page readiness notifications');
  this.pageLoading = false;
  if (this.pageLoadDelay) {
    this.pageLoadDelay.cancel();
  }
}
async function pageUnload() {
  _logger.default.debug('Page unloading');
  await this.waitForDom();
}
async function waitForDom(startPageLoadTimer, pageLoadVerifyHook) {
  _logger.default.debug('Waiting for dom...');
  await this.pageLoad(startPageLoadTimer, pageLoadVerifyHook);
}
async function checkPageIsReady() {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey
  });
  _logger.default.debug('Checking document readyState');
  const readyCmd = 'document.readyState;';
  let readyState = 'loading';
  try {
    readyState = await _bluebird.default.resolve(this.execute(readyCmd, true)).timeout(this.pageReadyTimeout);
  } catch (err) {
    if (!(err instanceof _bluebird.default.TimeoutError)) {
      throw err;
    }
    _logger.default.debug(`Page readiness check timed out after ${this.pageReadyTimeout}ms`);
    return false;
  }
  _logger.default.debug(`Document readyState is '${readyState}'`);
  return readyState === 'complete';
}
async function navToUrl(url, pageLoadVerifyHook) {
  (0, _utils.checkParams)({
    appIdKey: this.appIdKey,
    pageIdKey: this.pageIdKey
  });
  this._navigatingToPage = true;
  try {
    _logger.default.debug(`Navigating to new URL: '${url}'`);

    const waitForFramePromise = this.waitForFrameNavigated();
    await this.rpcClient.send('Page.navigate', {
      url,
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
    if (!this.useNewSafari) {
      await _bluebird.default.delay(1000);
    }

    await waitForFramePromise;
    await this.waitForDom(new _support.timing.Timer().start(), pageLoadVerifyHook);

    await this.rpcClient.send('Console.enable', {
      appIdKey: this.appIdKey,
      pageIdKey: this.pageIdKey
    });
  } finally {
    this._navigatingToPage = false;
  }
}
async function waitForFrameNavigated() {
  let navEventListener;
  return await new _bluebird.default(async resolve => {
    _logger.default.debug('Waiting for frame navigated message...');
    const start = new _support.timing.Timer().start();

    navEventListener = (err, value) => {
      _logger.default.debug(`Frame navigated in ${start.getDuration().asMilliSeconds.toFixed(0)}ms from: ${value}`);
      if (!this.allowNavigationWithoutReload && !this.pageLoading) {
        resolve(value);
      } else {
        _logger.default.debug('Frame navigated but we were warned about it, not ' + 'considering page state unloaded');
        this.allowNavigationWithoutReload = false;
      }
      if (this.navigationDelay) {
        this.navigationDelay.cancel();
      }
    };
    this.rpcClient.once('Page.frameNavigated', navEventListener);

    if (!this.useNewSafari || this.pageLoadMs >= 0) {
      const timeout = this.useNewSafari ? this.pageLoadMs : 500;
      this.navigationDelay = _support.util.cancellableDelay(timeout);
      try {
        await this.navigationDelay;
        navEventListener(null, `${timeout}ms timeout`);
      } catch (err) {
      }
    }
  }).finally(() => {
    if (navEventListener) {
      this.rpcClient.off('Page.frameNavigated', navEventListener);
    }
  });
}
var _default = {
  frameDetached,
  pageLoad,
  cancelPageLoad,
  pageUnload,
  waitForDom,
  checkPageIsReady,
  navToUrl,
  waitForFrameNavigated
};
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJmcmFtZURldGFjaGVkIiwiZW1pdCIsImV2ZW50cyIsIkVWRU5UX0ZSQU1FU19ERVRBQ0hFRCIsInBhZ2VMb2FkIiwic3RhcnRQYWdlTG9hZFRpbWVyIiwicGFnZUxvYWRWZXJpZnlIb29rIiwiXyIsIm5vb3AiLCJ0aW1lb3V0TXMiLCJpc0Z1bmN0aW9uIiwiZ2V0RHVyYXRpb24iLCJsb2ciLCJkZWJ1ZyIsInRpbWluZyIsIlRpbWVyIiwic3RhcnQiLCJwYWdlTG9hZGluZyIsInZlcmlmeSIsInBhZ2VMb2FkRGVsYXkiLCJ1dGlsIiwiY2FuY2VsbGFibGVEZWxheSIsImVyciIsIkIiLCJDYW5jZWxsYXRpb25FcnJvciIsImFwcElkS2V5IiwiZWxhcHNlZE1zIiwiYXNNaWxsaVNlY29uZHMiLCJjaGVja1BhZ2VJc1JlYWR5IiwicGFnZUxvYWRNcyIsInRvRml4ZWQiLCJjYW5jZWxQYWdlTG9hZCIsImNhbmNlbCIsInBhZ2VVbmxvYWQiLCJ3YWl0Rm9yRG9tIiwiY2hlY2tQYXJhbXMiLCJyZWFkeUNtZCIsInJlYWR5U3RhdGUiLCJyZXNvbHZlIiwiZXhlY3V0ZSIsInRpbWVvdXQiLCJwYWdlUmVhZHlUaW1lb3V0IiwiVGltZW91dEVycm9yIiwibmF2VG9VcmwiLCJ1cmwiLCJwYWdlSWRLZXkiLCJfbmF2aWdhdGluZ1RvUGFnZSIsIndhaXRGb3JGcmFtZVByb21pc2UiLCJ3YWl0Rm9yRnJhbWVOYXZpZ2F0ZWQiLCJycGNDbGllbnQiLCJzZW5kIiwidXNlTmV3U2FmYXJpIiwiZGVsYXkiLCJuYXZFdmVudExpc3RlbmVyIiwidmFsdWUiLCJhbGxvd05hdmlnYXRpb25XaXRob3V0UmVsb2FkIiwibmF2aWdhdGlvbkRlbGF5Iiwib25jZSIsImZpbmFsbHkiLCJvZmYiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvbWl4aW5zL25hdmlnYXRlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGNoZWNrUGFyYW1zIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IGV2ZW50cyBmcm9tICcuL2V2ZW50cyc7XG5pbXBvcnQgeyB0aW1pbmcsIHV0aWwgfSBmcm9tICdhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmZ1bmN0aW9uIGZyYW1lRGV0YWNoZWQgKCkge1xuICB0aGlzLmVtaXQoZXZlbnRzLkVWRU5UX0ZSQU1FU19ERVRBQ0hFRCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhZ2VMb2FkIChzdGFydFBhZ2VMb2FkVGltZXIsIHBhZ2VMb2FkVmVyaWZ5SG9vayA9IF8ubm9vcCkge1xuICBjb25zdCB0aW1lb3V0TXMgPSA1MDA7XG4gIGlmICghXy5pc0Z1bmN0aW9uKHN0YXJ0UGFnZUxvYWRUaW1lcj8uZ2V0RHVyYXRpb24pKSB7XG4gICAgbG9nLmRlYnVnKGBQYWdlIGxvYWQgdGltZXIgbm90IGEgdGltZXIuIENyZWF0aW5nIG5ldyB0aW1lcmApO1xuICAgIHN0YXJ0UGFnZUxvYWRUaW1lciA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdQYWdlIGxvYWRlZCwgdmVyaWZ5aW5nIHdoZXRoZXIgcmVhZHknKTtcbiAgdGhpcy5wYWdlTG9hZGluZyA9IHRydWU7XG5cbiAgY29uc3QgdmVyaWZ5ID0gYXN5bmMgKCkgPT4ge1xuICAgIHRoaXMucGFnZUxvYWREZWxheSA9IHV0aWwuY2FuY2VsbGFibGVEZWxheSh0aW1lb3V0TXMpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnBhZ2VMb2FkRGVsYXk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyIGluc3RhbmNlb2YgQi5DYW5jZWxsYXRpb25FcnJvcikge1xuICAgICAgICAvLyBpZiB0aGUgcHJvbWlzZSBoYXMgYmVlbiBjYW5jZWxsZWRcbiAgICAgICAgLy8gd2Ugd2FudCB0byBza2lwIGNoZWNraW5nIHRoZSByZWFkaW5lc3NcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHdlIGNhbiBnZXQgdGhpcyBjYWxsZWQgaW4gdGhlIG1pZGRsZSBvZiB0cnlpbmcgdG8gZmluZCBhIG5ldyBhcHBcbiAgICBpZiAoIXRoaXMuYXBwSWRLZXkpIHtcbiAgICAgIGxvZy5kZWJ1ZygnTm90IGNvbm5lY3RlZCB0byBhbiBhcHBsaWNhdGlvbi4gSWdub3JpbmcgcGFnZSBsb2FkJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKF8uaXNGdW5jdGlvbihwYWdlTG9hZFZlcmlmeUhvb2spKSB7XG4gICAgICBhd2FpdCBwYWdlTG9hZFZlcmlmeUhvb2soKTtcbiAgICB9XG5cbiAgICAvLyBpZiB3ZSBhcmUgcmVhZHksIG9yIHdlJ3ZlIHNwZW5kIHRvbyBtdWNoIHRpbWUgb24gdGhpc1xuICAgIGNvbnN0IGVsYXBzZWRNcyA9IHN0YXJ0UGFnZUxvYWRUaW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzO1xuICAgIGlmIChhd2FpdCB0aGlzLmNoZWNrUGFnZUlzUmVhZHkoKSB8fCAodGhpcy5wYWdlTG9hZE1zID4gMCAmJiBlbGFwc2VkTXMgPiB0aGlzLnBhZ2VMb2FkTXMpKSB7XG4gICAgICBsb2cuZGVidWcoJ1BhZ2UgaXMgcmVhZHknKTtcbiAgICAgIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKCdQYWdlIHdhcyBub3QgcmVhZHksIHJldHJ5aW5nJyk7XG4gICAgICBhd2FpdCB2ZXJpZnkoKTtcbiAgICB9XG4gIH07XG4gIHRyeSB7XG4gICAgYXdhaXQgdmVyaWZ5KCk7XG4gIH0gZmluYWxseSB7XG4gICAgbG9nLmRlYnVnKGBQYWdlIGxvYWQgY29tcGxldGVkIGluICR7c3RhcnRQYWdlTG9hZFRpbWVyLmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tc2ApO1xuICAgIHRoaXMucGFnZUxvYWRpbmcgPSBmYWxzZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjYW5jZWxQYWdlTG9hZCAoKSB7XG4gIGxvZy5kZWJ1ZygnVW5yZWdpc3RlcmluZyBmcm9tIHBhZ2UgcmVhZGluZXNzIG5vdGlmaWNhdGlvbnMnKTtcbiAgdGhpcy5wYWdlTG9hZGluZyA9IGZhbHNlO1xuICBpZiAodGhpcy5wYWdlTG9hZERlbGF5KSB7XG4gICAgdGhpcy5wYWdlTG9hZERlbGF5LmNhbmNlbCgpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHBhZ2VVbmxvYWQgKCkge1xuICBsb2cuZGVidWcoJ1BhZ2UgdW5sb2FkaW5nJyk7XG4gIGF3YWl0IHRoaXMud2FpdEZvckRvbSgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiB3YWl0Rm9yRG9tIChzdGFydFBhZ2VMb2FkVGltZXIsIHBhZ2VMb2FkVmVyaWZ5SG9vaykge1xuICBsb2cuZGVidWcoJ1dhaXRpbmcgZm9yIGRvbS4uLicpO1xuICBhd2FpdCB0aGlzLnBhZ2VMb2FkKHN0YXJ0UGFnZUxvYWRUaW1lciwgcGFnZUxvYWRWZXJpZnlIb29rKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2hlY2tQYWdlSXNSZWFkeSAoKSB7XG4gIGNoZWNrUGFyYW1zKHthcHBJZEtleTogdGhpcy5hcHBJZEtleX0pO1xuXG4gIGxvZy5kZWJ1ZygnQ2hlY2tpbmcgZG9jdW1lbnQgcmVhZHlTdGF0ZScpO1xuICBjb25zdCByZWFkeUNtZCA9ICdkb2N1bWVudC5yZWFkeVN0YXRlOyc7XG4gIGxldCByZWFkeVN0YXRlID0gJ2xvYWRpbmcnO1xuICB0cnkge1xuICAgIHJlYWR5U3RhdGUgPSBhd2FpdCBCLnJlc29sdmUodGhpcy5leGVjdXRlKHJlYWR5Q21kLCB0cnVlKSkudGltZW91dCh0aGlzLnBhZ2VSZWFkeVRpbWVvdXQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAoIShlcnIgaW5zdGFuY2VvZiBCLlRpbWVvdXRFcnJvcikpIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBQYWdlIHJlYWRpbmVzcyBjaGVjayB0aW1lZCBvdXQgYWZ0ZXIgJHt0aGlzLnBhZ2VSZWFkeVRpbWVvdXR9bXNgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgbG9nLmRlYnVnKGBEb2N1bWVudCByZWFkeVN0YXRlIGlzICcke3JlYWR5U3RhdGV9J2ApO1xuXG4gIHJldHVybiByZWFkeVN0YXRlID09PSAnY29tcGxldGUnO1xufVxuXG5hc3luYyBmdW5jdGlvbiBuYXZUb1VybCAodXJsLCBwYWdlTG9hZFZlcmlmeUhvb2spIHtcbiAgY2hlY2tQYXJhbXMoe2FwcElkS2V5OiB0aGlzLmFwcElkS2V5LCBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5fSk7XG5cbiAgdGhpcy5fbmF2aWdhdGluZ1RvUGFnZSA9IHRydWU7XG5cbiAgdHJ5IHtcbiAgICBsb2cuZGVidWcoYE5hdmlnYXRpbmcgdG8gbmV3IFVSTDogJyR7dXJsfSdgKTtcblxuICAgIC8vIGJlZ2luIGxpc3RlbmluZyBmb3IgZnJhbWUgbmF2aWdhdGlvbiBldmVudCwgd2hpY2ggd2lsbCBiZSB3YWl0ZWQgZm9yIGxhdGVyXG4gICAgY29uc3Qgd2FpdEZvckZyYW1lUHJvbWlzZSA9IHRoaXMud2FpdEZvckZyYW1lTmF2aWdhdGVkKCk7XG5cbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdQYWdlLm5hdmlnYXRlJywge1xuICAgICAgdXJsLFxuICAgICAgYXBwSWRLZXk6IHRoaXMuYXBwSWRLZXksXG4gICAgICBwYWdlSWRLZXk6IHRoaXMucGFnZUlkS2V5LFxuICAgIH0pO1xuXG4gICAgaWYgKCF0aGlzLnVzZU5ld1NhZmFyaSkge1xuICAgICAgLy8gYSBzbWFsbCBwYXVzZSBmb3IgdGhlIGJyb3dzZXIgdG8gY2F0Y2ggdXBcbiAgICAgIGF3YWl0IEIuZGVsYXkoMTAwMCk7XG4gICAgfVxuXG4gICAgLy8gd2FpdCB1bnRpbCB0aGUgcGFnZSBoYXMgYmVlbiBuYXZpZ2F0ZWRcbiAgICBhd2FpdCB3YWl0Rm9yRnJhbWVQcm9taXNlO1xuXG4gICAgYXdhaXQgdGhpcy53YWl0Rm9yRG9tKG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpLCBwYWdlTG9hZFZlcmlmeUhvb2spO1xuXG4gICAgLy8gZW5hYmxlIGNvbnNvbGUgbG9nZ2luZywgc28gd2UgZ2V0IHRoZSBldmVudHMgKG90aGVyd2lzZSB3ZSBvbmx5XG4gICAgLy8gZ2V0IG5vdGlmaWVkIHdoZW4gbmF2aWdhdGluZyB0byBhIGxvY2FsIHBhZ2VcbiAgICBhd2FpdCB0aGlzLnJwY0NsaWVudC5zZW5kKCdDb25zb2xlLmVuYWJsZScsIHtcbiAgICAgIGFwcElkS2V5OiB0aGlzLmFwcElkS2V5LFxuICAgICAgcGFnZUlkS2V5OiB0aGlzLnBhZ2VJZEtleSxcbiAgICB9KTtcbiAgfSBmaW5hbGx5IHtcbiAgICB0aGlzLl9uYXZpZ2F0aW5nVG9QYWdlID0gZmFsc2U7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gd2FpdEZvckZyYW1lTmF2aWdhdGVkICgpIHtcbiAgbGV0IG5hdkV2ZW50TGlzdGVuZXI7XG4gIHJldHVybiBhd2FpdCBuZXcgQihhc3luYyAocmVzb2x2ZSkgPT4ge1xuICAgIGxvZy5kZWJ1ZygnV2FpdGluZyBmb3IgZnJhbWUgbmF2aWdhdGVkIG1lc3NhZ2UuLi4nKTtcbiAgICBjb25zdCBzdGFydCA9IG5ldyB0aW1pbmcuVGltZXIoKS5zdGFydCgpO1xuXG4gICAgLy8gYWRkIGEgaGFuZGxlciBmb3IgdGhlIGBQYWdlLmZyYW1lTmF2aWdhdGVkYCBtZXNzYWdlXG4gICAgLy8gZnJvbSB0aGUgcmVtb3RlIGRlYnVnZ2VyXG4gICAgbmF2RXZlbnRMaXN0ZW5lciA9IChlcnIsIHZhbHVlKSA9PiB7XG4gICAgICBsb2cuZGVidWcoYEZyYW1lIG5hdmlnYXRlZCBpbiAke3N0YXJ0LmdldER1cmF0aW9uKCkuYXNNaWxsaVNlY29uZHMudG9GaXhlZCgwKX1tcyBmcm9tOiAke3ZhbHVlfWApO1xuICAgICAgaWYgKCF0aGlzLmFsbG93TmF2aWdhdGlvbldpdGhvdXRSZWxvYWQgJiYgIXRoaXMucGFnZUxvYWRpbmcpIHtcbiAgICAgICAgcmVzb2x2ZSh2YWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2cuZGVidWcoJ0ZyYW1lIG5hdmlnYXRlZCBidXQgd2Ugd2VyZSB3YXJuZWQgYWJvdXQgaXQsIG5vdCAnICtcbiAgICAgICAgICAgICAgICAgICdjb25zaWRlcmluZyBwYWdlIHN0YXRlIHVubG9hZGVkJyk7XG4gICAgICAgIHRoaXMuYWxsb3dOYXZpZ2F0aW9uV2l0aG91dFJlbG9hZCA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMubmF2aWdhdGlvbkRlbGF5KSB7XG4gICAgICAgIHRoaXMubmF2aWdhdGlvbkRlbGF5LmNhbmNlbCgpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLnJwY0NsaWVudC5vbmNlKCdQYWdlLmZyYW1lTmF2aWdhdGVkJywgbmF2RXZlbnRMaXN0ZW5lcik7XG5cbiAgICAvLyB0aW1lb3V0LCBpbiBjYXNlIHJlbW90ZSBkZWJ1Z2dlciBkb2Vzbid0IHJlc3BvbmQsXG4gICAgLy8gb3IgdGFrZXMgYSBsb25nIHRpbWVcbiAgICBpZiAoIXRoaXMudXNlTmV3U2FmYXJpIHx8IHRoaXMucGFnZUxvYWRNcyA+PSAwKSB7XG4gICAgICAvLyB1c2UgcGFnZUxvYWRNcywgb3IgYSBzbWFsbCBhbW91bnQgb2YgdGltZVxuICAgICAgY29uc3QgdGltZW91dCA9IHRoaXMudXNlTmV3U2FmYXJpID8gdGhpcy5wYWdlTG9hZE1zIDogNTAwO1xuICAgICAgdGhpcy5uYXZpZ2F0aW9uRGVsYXkgPSB1dGlsLmNhbmNlbGxhYmxlRGVsYXkodGltZW91dCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLm5hdmlnYXRpb25EZWxheTtcbiAgICAgICAgbmF2RXZlbnRMaXN0ZW5lcihudWxsLCBgJHt0aW1lb3V0fW1zIHRpbWVvdXRgKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyBub3RoaW5nIHRvIGRvOiB3ZSBvbmx5IGdldCBoZXJlIGlmIHRoZSByZW1vdGUgZGVidWdnZXJcbiAgICAgICAgLy8gYWxyZWFkeSBub3RpZmllZCBvZiBmcmFtZSBuYXZpZ2F0aW9uLCBhbmQgdGhlIGRlbGF5XG4gICAgICAgIC8vIHdhcyBjYW5jZWxsZWRcbiAgICAgIH1cbiAgICB9XG4gIH0pLmZpbmFsbHkoKCkgPT4ge1xuICAgIGlmIChuYXZFdmVudExpc3RlbmVyKSB7XG4gICAgICB0aGlzLnJwY0NsaWVudC5vZmYoJ1BhZ2UuZnJhbWVOYXZpZ2F0ZWQnLCBuYXZFdmVudExpc3RlbmVyKTtcbiAgICB9XG4gIH0pO1xufVxuXG5cbmV4cG9ydCBkZWZhdWx0IHsgZnJhbWVEZXRhY2hlZCwgcGFnZUxvYWQsIGNhbmNlbFBhZ2VMb2FkLCBwYWdlVW5sb2FkLCB3YWl0Rm9yRG9tLCBjaGVja1BhZ2VJc1JlYWR5LCBuYXZUb1VybCwgd2FpdEZvckZyYW1lTmF2aWdhdGVkIH07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBR0EsU0FBU0EsYUFBYSxHQUFJO0VBQ3hCLElBQUksQ0FBQ0MsSUFBSSxDQUFDQyxlQUFNLENBQUNDLHFCQUFxQixDQUFDO0FBQ3pDO0FBRUEsZUFBZUMsUUFBUSxDQUFFQyxrQkFBa0IsRUFBRUMsa0JBQWtCLEdBQUdDLGVBQUMsQ0FBQ0MsSUFBSSxFQUFFO0VBQUE7RUFDeEUsTUFBTUMsU0FBUyxHQUFHLEdBQUc7RUFDckIsSUFBSSxDQUFDRixlQUFDLENBQUNHLFVBQVUsd0JBQUNMLGtCQUFrQix3REFBbEIsb0JBQW9CTSxXQUFXLENBQUMsRUFBRTtJQUNsREMsZUFBRyxDQUFDQyxLQUFLLENBQUUsaURBQWdELENBQUM7SUFDNURSLGtCQUFrQixHQUFHLElBQUlTLGVBQU0sQ0FBQ0MsS0FBSyxFQUFFLENBQUNDLEtBQUssRUFBRTtFQUNqRDtFQUVBSixlQUFHLENBQUNDLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQztFQUNqRCxJQUFJLENBQUNJLFdB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