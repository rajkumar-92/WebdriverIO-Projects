{"version":3,"file":"launcher.js","sourceRoot":"","sources":["../src/launcher.ts"],"names":[],"mappings":"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","sourcesContent":["import os from 'os'\nimport fs from 'fs/promises'\nimport path from 'path'\nimport { format } from 'util'\n\nimport downloadBundle from 'download'\nimport logger from '@wdio/logger'\nimport { request } from 'undici'\nimport { download } from '@vscode/test-electron'\nimport { SevereServiceError } from 'webdriverio'\nimport { launcher as ChromedriverServiceLauncher } from 'wdio-chromedriver-service'\nimport type { Options, Capabilities } from '@wdio/types'\n\nimport startServer from './server'\nimport {\n    validatePlatform, fileExist, directoryExists, isMultiremote,\n    isChrome\n} from './utils'\nimport {\n    DEFAULT_CHANNEL, VSCODE_RELEASES, VSCODE_MANIFEST_URL, CHROMEDRIVER_RELEASES,\n    CHROMEDRIVER_DOWNLOAD_PATH, DEFAULT_CACHE_PATH, VSCODE_CAPABILITY_KEY,\n    VSCODE_WEB_STANDALONE, DEFAULT_VSCODE_WEB_HOSTNAME\n} from './constants'\nimport type {\n    ServiceOptions, ServiceCapability, VSCodeCapabilities, WebStandaloneResponse,\n    Bundle\n} from './types'\n\ninterface BundeInformation {\n    chromedriver: string\n    vscode: string\n}\ninterface Manifest {\n    registrations: Registration[]\n}\ninterface Registration {\n    version: string\n    component: {\n        git: {\n            name: string\n        }\n    }\n}\ntype Versions = { [desiredVersion: string]: BundeInformation | undefined }\n\nconst VERSIONS_TXT = 'versions.txt'\nconst log = logger('wdio-vscode-service/launcher')\nexport default class VSCodeServiceLauncher extends ChromedriverServiceLauncher {\n    private _cachePath: string\n    private _vscodeServerPort?: number\n\n    constructor (\n        private _options: ServiceOptions,\n        private _capabilities: Capabilities.Capabilities,\n        config: Options.Testrunner\n    ) {\n        super(_options, _capabilities, config)\n        this._cachePath = this._options.cachePath || DEFAULT_CACHE_PATH\n        this._mapCapabilities = () => {}\n    }\n\n    // @ts-expect-error this service uses provided params\n    async onPrepare (_: never, capabilities: Capabilities.RemoteCapabilities) {\n        const caps: VSCodeCapabilities[] = Array.isArray(capabilities)\n            ? capabilities.map((c) => ((c as Capabilities.W3CCapabilities).alwaysMatch || c) as VSCodeCapabilities)\n            : Object.values(capabilities).map((c) => c.capabilities as VSCodeCapabilities)\n\n        /**\n         * check if for given version we already have all bundles\n         * and continue without download if possible\n         */\n        const versionsFilePath = path.join(this._cachePath, VERSIONS_TXT)\n        const versionsFileExist = await fileExist(versionsFilePath)\n\n        for (const cap of caps) {\n            /**\n             * skip setup if user is not using VSCode as capability\n             */\n            if (typeof cap.browserName !== 'string' || !cap[VSCODE_CAPABILITY_KEY]) {\n                continue\n            }\n\n            const version = cap[VSCODE_CAPABILITY_KEY].version || cap.browserVersion || DEFAULT_CHANNEL\n\n            /**\n             * setup VSCode Desktop\n             */\n            if (cap.browserName === 'vscode') {\n                await this._setupVSCodeDesktop(versionsFileExist, versionsFilePath, version, cap)\n                continue\n            }\n\n            /**\n             * setup VSCode Web\n             */\n            await this._setupVSCodeWeb(version, cap)\n            // @ts-expect-error CJS\n            const instance = await this.instance\n            this._mapBrowserCapabilities(instance.options as ServiceOptions)\n        }\n\n        return super.onPrepare()\n    }\n\n    /**\n     * Set up VSCode for web testing\n     * @param versionsFileExist true if we already have information stored about cached VSCode and Chromedriver bundles\n     * @param versionsFilePath string with path to cached directory\n     * @param cap capabilities used for this test run\n     */\n    private async _setupVSCodeWeb (\n        version: string,\n        cap: VSCodeCapabilities\n    ) {\n        /**\n         * no need to do any work if we already started the server\n         */\n        if (this._vscodeServerPort || !cap[VSCODE_CAPABILITY_KEY]) {\n            return\n        }\n\n        try {\n            const vscodeStandalone = await this._fetchVSCodeWebStandalone(version)\n            const port = await startServer(vscodeStandalone, cap[VSCODE_CAPABILITY_KEY])\n            cap[VSCODE_CAPABILITY_KEY].serverOptions = {\n                ...(cap[VSCODE_CAPABILITY_KEY].serverOptions || {\n                    hostname: DEFAULT_VSCODE_WEB_HOSTNAME\n                }),\n                port\n            }\n        } catch (err: any) {\n            throw new SevereServiceError(`Couldn't start server for VSCode Web: ${err.message}`)\n        }\n    }\n\n    /**\n     * Set up VSCode for desktop testing\n     * @param versionsFileExist true if we already have information stored about cached VSCode and Chromedriver bundles\n     * @param versionsFilePath string with path to cached directory\n     * @param cap capabilities used for this test run\n     */\n    private async _setupVSCodeDesktop (\n        versionsFileExist: boolean,\n        versionsFilePath: string,\n        version: string,\n        cap: VSCodeCapabilities\n    ) {\n        if (!cap[VSCODE_CAPABILITY_KEY]) {\n            throw new Error(`No key \"${VSCODE_CAPABILITY_KEY}\" found in caps`)\n        }\n\n        // @ts-expect-error CJS\n        const instance = await this.instance\n        if (versionsFileExist) {\n            const content = JSON.parse((await fs.readFile(versionsFilePath)).toString()) as Versions\n            const chromedriverPath = path.join(this._cachePath, `chromedriver-${content[version]?.chromedriver}`)\n            const vscodePath = (\n                cap[VSCODE_CAPABILITY_KEY]?.binary\n                || path.join(this._cachePath, `vscode-${process.platform}-${content[version]?.vscode}`)\n            )\n\n            if (content[version] && await fileExist(chromedriverPath) && await fileExist(vscodePath)) {\n                log.info(\n                    `Skipping download, bundles for VSCode v${content[version]?.vscode} `\n                    + `and Chromedriver v${content[version]?.chromedriver} already exist`\n                )\n\n                Object.assign(cap, instance.options)\n                cap[VSCODE_CAPABILITY_KEY].binary = (\n                    cap[VSCODE_CAPABILITY_KEY].binary\n                    || await this._downloadVSCode(content[version]?.vscode as string)\n                )\n                instance.chromedriverCustomPath = chromedriverPath\n                return\n            }\n        }\n\n        const [vscodeVersion, chromedriverVersion, chromedriverPath] = await this._setupChromedriver(version)\n        instance.chromedriverCustomPath = chromedriverPath\n        const serviceArgs: ServiceCapability = {\n            chromedriver: { version: chromedriverVersion, path: chromedriverPath },\n            vscode: {\n                version: vscodeVersion,\n                path: cap[VSCODE_CAPABILITY_KEY]?.binary || await this._downloadVSCode(vscodeVersion)\n            }\n        }\n        Object.assign(cap, instance.options)\n        cap[VSCODE_CAPABILITY_KEY].binary = serviceArgs.vscode.path\n        await this._updateVersionsTxt(version, serviceArgs, versionsFileExist)\n    }\n\n    /**\n     * Downloads Chromedriver bundle for given VSCode version\n     * @param desiredReleaseChannel either release channel (e.g. \"stable\" or \"insiders\")\n     *                              or a concrete version e.g. 1.66.0\n     * @returns \"insiders\" if `desiredReleaseChannel` is set to this otherwise a concrete version\n     */\n    private async _setupChromedriver (desiredReleaseChannel: string) {\n        const version = await this._fetchVSCodeVersion(desiredReleaseChannel)\n\n        try {\n            const chromedriverVersion = await this._fetchChromedriverVersion(version)\n\n            log.info(`Download Chromedriver (v${chromedriverVersion})`)\n            await downloadBundle(\n                format(CHROMEDRIVER_DOWNLOAD_PATH, chromedriverVersion, validatePlatform()),\n                this._cachePath,\n                { extract: true, strip: 1 }\n            )\n\n            const ext = os.platform().startsWith('win') ? '.exe' : ''\n            const chromedriverPath = path.join(this._cachePath, `chromedriver-${chromedriverVersion}${ext}`)\n            await fs.rename(path.join(this._cachePath, `chromedriver${ext}`), chromedriverPath)\n\n            /**\n             * return 'insiders' if desired release channel\n             */\n            return version === 'main'\n                ? [desiredReleaseChannel, chromedriverVersion, chromedriverPath]\n                : [version, chromedriverVersion, chromedriverPath]\n        } catch (err: any) {\n            throw new SevereServiceError(`Couldn't set up Chromedriver ${err.message}`)\n        }\n    }\n\n    /**\n     * Download VSCode bundle\n     * @param version VSCode version\n     * @returns path to downloaded VSCode bundle\n     */\n    private async _downloadVSCode (version: string) {\n        try {\n            log.info(`Download VSCode binary (${version})`)\n            return await download({\n                cachePath: this._cachePath,\n                version\n            })\n        } catch (err: any) {\n            throw new SevereServiceError(`Couldn't set up VSCode: ${err.message}`)\n        }\n    }\n\n    /**\n     * Get VSCode version based on desired channel or validate version if provided\n     * @param desiredReleaseChannel either release channel (e.g. \"stable\" or \"insiders\")\n     *                              or a concrete version e.g. 1.66.0\n     * @returns \"main\" if `desiredReleaseChannel` is \"insiders\" otherwise a concrete VSCode version\n     */\n    private async _fetchVSCodeVersion (desiredReleaseChannel?: string | string) {\n        if (desiredReleaseChannel === 'insiders') {\n            return 'main'\n        }\n\n        try {\n            log.info(`Fetch releases from ${VSCODE_RELEASES}`)\n            const { body: versions } = await request(VSCODE_RELEASES, {})\n            const availableVersions: string[] = await versions.json()\n\n            if (desiredReleaseChannel) {\n                /**\n                 * validate provided VSCode version\n                 */\n                const newDesiredReleaseChannel = desiredReleaseChannel === 'stable'\n                    ? availableVersions[0]\n                    : desiredReleaseChannel\n                if (!availableVersions.includes(newDesiredReleaseChannel)) {\n                    throw new Error(\n                        `Desired version \"${newDesiredReleaseChannel}\" is not existent, available versions:`\n                        + `${availableVersions.slice(0, 5).join(', ')}..., see ${VSCODE_RELEASES}`\n                    )\n                }\n\n                return newDesiredReleaseChannel\n            }\n\n            return availableVersions[0]\n        } catch (err: any) {\n            throw new SevereServiceError(`Couldn't fetch latest VSCode: ${err.message}`)\n        }\n    }\n\n    /**\n     * Fetches required Chromedriver version for given VSCode version\n     * @param vscodeVersion branch or tag version of VSCode repository\n     * @returns required Chromedriver version\n     */\n    private async _fetchChromedriverVersion (vscodeVersion: string) {\n        try {\n            const { body } = await request(format(VSCODE_MANIFEST_URL, vscodeVersion), {})\n            const manifest: Manifest = await body.json()\n            const chromium = manifest.registrations.find((r: any) => r.component.git.name === 'chromium')\n\n            if (!chromium) {\n                throw new Error('Can\\'t find chromium version in manifest response')\n            }\n\n            const { body: chromedriverVersion } = await request(\n                format(CHROMEDRIVER_RELEASES, chromium.version.split('.')[0]),\n                {}\n            )\n            return await chromedriverVersion.text()\n        } catch (err: any) {\n            throw new SevereServiceError(`Couldn't fetch Chromedriver version: ${err.message}`)\n        }\n    }\n\n    /**\n     * Fetches VSCode Web files\n     * ToDo(Christian): allow to define a local VSCode development path\n     *                  to be able to skip this part\n     */\n    private async _fetchVSCodeWebStandalone (vscodeVersion: string): Promise<Bundle> {\n        if (vscodeVersion !== 'stable' && vscodeVersion !== 'insiders') {\n            throw new Error('Running VSCode in the browser is only supported for \"stable\" and \"insiders\" version')\n        }\n\n        try {\n            const { body } = await request(format(VSCODE_WEB_STANDALONE, vscodeVersion), {})\n            const info: WebStandaloneResponse = await body.json()\n            const folder = path.join(this._cachePath, `vscode-web-${vscodeVersion}-${info.version}`)\n\n            if (!(await directoryExists(folder))) {\n                await downloadBundle(info.url, folder, { extract: true, strip: 1 })\n            }\n\n            return { path: folder, vscodeVersion, version: info.version }\n        } catch (err: any) {\n            throw new SevereServiceError(`Couldn't set up VSCode Web: ${err.message}`)\n        }\n    }\n\n    private async _updateVersionsTxt (version: string, serviceArgs: ServiceCapability, versionsFileExist: boolean) {\n        const newContent: Versions = {\n            [version]: {\n                chromedriver: serviceArgs.chromedriver.version,\n                vscode: serviceArgs.vscode.version\n            }\n        }\n        const versionsTxtPath = path.join(this._cachePath, VERSIONS_TXT)\n        if (!versionsFileExist) {\n            return fs.writeFile(\n                versionsTxtPath,\n                JSON.stringify(newContent, null, 4),\n                'utf-8'\n            )\n        }\n\n        const content = JSON.parse((await fs.readFile(versionsTxtPath, 'utf-8')).toString())\n        return fs.writeFile(\n            versionsTxtPath,\n            JSON.stringify({ ...content, ...newContent }, null, 4),\n            'utf-8'\n        )\n    }\n\n    private _mapBrowserCapabilities (options: ServiceOptions) {\n        if (isMultiremote(this._capabilities)) {\n            throw new SevereServiceError('This service deson\\'t support multiremote yet')\n        }\n\n        for (const cap of this._capabilities as any as Capabilities.Capabilities[]) {\n            if (isChrome(cap)) {\n                Object.assign(cap, options)\n            }\n        }\n    }\n}\n"]}