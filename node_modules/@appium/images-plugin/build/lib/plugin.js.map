{"version":3,"file":"plugin.js","names":["IMAGE_STRATEGY","getImgElFromArgs","args","arg","_","isString","startsWith","IMAGE_ELEMENT_PREFIX","ImageElementPlugin","BasePlugin","constructor","pluginName","finder","ImageElementFinder","newMethodMap","POST","command","payloadParams","required","optional","neverProxy","compareImages","next","driver","findElement","_find","findElements","multiple","strategy","selector","setDriver","findByImage","handle","cmdName","imgElId","imgElCache","has","errors","NoSuchElementError","imgEl","get","ImageElement","execute"],"sources":["../../lib/plugin.js"],"sourcesContent":["/* eslint-disable no-case-declarations */\n\nimport _ from 'lodash';\nimport {errors} from 'appium/driver';\nimport BasePlugin from 'appium/plugin';\nimport {compareImages} from './compare';\nimport ImageElementFinder from './finder';\nimport {ImageElement, IMAGE_ELEMENT_PREFIX} from './image-element';\n\nconst IMAGE_STRATEGY = '-image';\n\nfunction getImgElFromArgs(args) {\n  for (let arg of args) {\n    if (_.isString(arg) && arg.startsWith(IMAGE_ELEMENT_PREFIX)) {\n      return arg;\n    }\n  }\n}\n\nexport default class ImageElementPlugin extends BasePlugin {\n  constructor(pluginName) {\n    super(pluginName);\n    this.finder = new ImageElementFinder();\n  }\n\n  // this plugin supports a non-standard 'compare images' command\n  static newMethodMap = {\n    '/session/:sessionId/appium/compare_images': {\n      POST: {\n        command: 'compareImages',\n        payloadParams: {\n          required: ['mode', 'firstImage', 'secondImage'],\n          optional: ['options'],\n        },\n        neverProxy: true,\n      },\n    },\n  };\n\n  async compareImages(next, driver, ...args) {\n    return await compareImages(...args);\n  }\n\n  async findElement(next, driver, ...args) {\n    return await this._find(false, next, driver, ...args);\n  }\n\n  async findElements(next, driver, ...args) {\n    return await this._find(true, next, driver, ...args);\n  }\n\n  async _find(multiple, next, driver, ...args) {\n    const [strategy, selector] = args;\n\n    // if we're not actually finding by image, just do the normal thing\n    if (strategy !== IMAGE_STRATEGY) {\n      return await next();\n    }\n\n    this.finder.setDriver(driver);\n    return await this.finder.findByImage(selector, {multiple});\n  }\n\n  async handle(next, driver, cmdName, ...args) {\n    // if we have a command that involves an image element id, attempt to find the image element\n    // and execute the command on it\n    const imgElId = getImgElFromArgs(args);\n    if (imgElId) {\n      if (!this.finder.imgElCache.has(imgElId)) {\n        throw new errors.NoSuchElementError();\n      }\n      const imgEl = this.finder.imgElCache.get(imgElId);\n      return await ImageElement.execute(driver, imgEl, cmdName, ...args);\n    }\n\n    // otherwise just do the normal thing\n    return await next();\n  }\n}\n\nexport {ImageElementPlugin, getImgElFromArgs, IMAGE_STRATEGY};\n"],"mappings":";;;;;;;;;;AAEA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;AAEA,MAAMA,cAAc,GAAG,QAAvB;;;AAEA,SAASC,gBAAT,CAA0BC,IAA1B,EAAgC;EAC9B,KAAK,IAAIC,GAAT,IAAgBD,IAAhB,EAAsB;IACpB,IAAIE,eAAA,CAAEC,QAAF,CAAWF,GAAX,KAAmBA,GAAG,CAACG,UAAJ,CAAeC,kCAAf,CAAvB,EAA6D;MAC3D,OAAOJ,GAAP;IACD;EACF;AACF;;AAEc,MAAMK,kBAAN,SAAiCC,eAAjC,CAA4C;EACzDC,WAAW,CAACC,UAAD,EAAa;IACtB,MAAMA,UAAN;IACA,KAAKC,MAAL,GAAc,IAAIC,eAAJ,EAAd;EACD;;EAGkB,OAAZC,YAAY,GAAG;IACpB,6CAA6C;MAC3CC,IAAI,EAAE;QACJC,OAAO,EAAE,eADL;QAEJC,aAAa,EAAE;UACbC,QAAQ,EAAE,CAAC,MAAD,EAAS,YAAT,EAAuB,aAAvB,CADG;UAEbC,QAAQ,EAAE,CAAC,SAAD;QAFG,CAFX;QAMJC,UAAU,EAAE;MANR;IADqC;EADzB,CAAH;;EAaA,MAAbC,aAAa,CAACC,IAAD,EAAOC,MAAP,EAAe,GAAGrB,IAAlB,EAAwB;IACzC,OAAO,MAAM,IAAAmB,sBAAA,EAAc,GAAGnB,IAAjB,CAAb;EACD;;EAEgB,MAAXsB,WAAW,CAACF,IAAD,EAAOC,MAAP,EAAe,GAAGrB,IAAlB,EAAwB;IACvC,OAAO,MAAM,KAAKuB,KAAL,CAAW,KAAX,EAAkBH,IAAlB,EAAwBC,MAAxB,EAAgC,GAAGrB,IAAnC,CAAb;EACD;;EAEiB,MAAZwB,YAAY,CAACJ,IAAD,EAAOC,MAAP,EAAe,GAAGrB,IAAlB,EAAwB;IACxC,OAAO,MAAM,KAAKuB,KAAL,CAAW,IAAX,EAAiBH,IAAjB,EAAuBC,MAAvB,EAA+B,GAAGrB,IAAlC,CAAb;EACD;;EAEU,MAALuB,KAAK,CAACE,QAAD,EAAWL,IAAX,EAAiBC,MAAjB,EAAyB,GAAGrB,IAA5B,EAAkC;IAC3C,MAAM,CAAC0B,QAAD,EAAWC,QAAX,IAAuB3B,IAA7B;;IAGA,IAAI0B,QAAQ,KAAK5B,cAAjB,EAAiC;MAC/B,OAAO,MAAMsB,IAAI,EAAjB;IACD;;IAED,KAAKV,MAAL,CAAYkB,SAAZ,CAAsBP,MAAtB;IACA,OAAO,MAAM,KAAKX,MAAL,CAAYmB,WAAZ,CAAwBF,QAAxB,EAAkC;MAACF;IAAD,CAAlC,CAAb;EACD;;EAEW,MAANK,MAAM,CAACV,IAAD,EAAOC,MAAP,EAAeU,OAAf,EAAwB,GAAG/B,IAA3B,EAAiC;IAG3C,MAAMgC,OAAO,GAAGjC,gBAAgB,CAACC,IAAD,CAAhC;;IACA,IAAIgC,OAAJ,EAAa;MACX,IAAI,CAAC,KAAKtB,MAAL,CAAYuB,UAAZ,CAAuBC,GAAvB,CAA2BF,OAA3B,CAAL,EAA0C;QACxC,MAAM,IAAIG,cAAA,CAAOC,kBAAX,EAAN;MACD;;MACD,MAAMC,KAAK,GAAG,KAAK3B,MAAL,CAAYuB,UAAZ,CAAuBK,GAAvB,CAA2BN,OAA3B,CAAd;MACA,OAAO,MAAMO,0BAAA,CAAaC,OAAb,CAAqBnB,MAArB,EAA6BgB,KAA7B,EAAoCN,OAApC,EAA6C,GAAG/B,IAAhD,CAAb;IACD;;IAGD,OAAO,MAAMoB,IAAI,EAAjB;EACD;;AA1DwD"}