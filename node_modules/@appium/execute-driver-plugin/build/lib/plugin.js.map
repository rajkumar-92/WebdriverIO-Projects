{"version":3,"file":"plugin.js","names":["FEAT_FLAG","DEFAULT_SCRIPT_TIMEOUT_MS","SCRIPT_TYPE_WDIO","ExecuteDriverPlugin","BasePlugin","newMethodMap","POST","command","payloadParams","required","optional","executeDriverScript","next","driver","script","scriptType","timeoutMs","isFeatureEnabled","Error","TypeError","serverHost","serverPort","_","isNumber","driverOpts","sessionId","protocol","hostname","port","path","serverPath","isW3C","isMobile","capabilities","caps","logger","info","childScript","require","resolve","scriptProc","cp","fork","timeoutCanceled","timer","timing","Timer","start","waitForResult","res","B","on","error","message","success","waitForTimeout","getDuration","asMilliSeconds","delay","send","race","err","connected","disconnect","exitCode","kill"],"sources":["../../lib/plugin.js"],"sourcesContent":["import {BasePlugin} from 'appium/plugin';\nimport _ from 'lodash';\nimport cp from 'child_process';\nimport {timing} from 'appium/support';\nimport B from 'bluebird';\n\nconst FEAT_FLAG = 'execute_driver_script';\nconst DEFAULT_SCRIPT_TIMEOUT_MS = 1000 * 60 * 60; // default to 1 hour timeout\nconst SCRIPT_TYPE_WDIO = 'webdriverio';\n\nexport default class ExecuteDriverPlugin extends BasePlugin {\n  static newMethodMap = {\n    '/session/:sessionId/appium/execute_driver': {\n      POST: {\n        command: 'executeDriverScript',\n        payloadParams: {required: ['script'], optional: ['type', 'timeout']},\n      },\n    },\n  };\n\n  /**\n   * This method takes a string which is executed as javascript in the context of\n   * a new nodejs VM, and which has available a webdriverio driver object, having\n   * already been attached to the currently running session.\n   *\n   * @param {function} next - standard behaviour for executeDriverScript\n   * @param {BaseDriver} driver - Appium driver handling this command\n   * @param {string} script - the string representing the driver script to run\n   * @param {string} [scriptType='webdriverio'] - the name of the driver script\n   * library (currently only webdriverio is supported)\n   * @param {number} [timeoutMs=3600000] - timeout for the script process\n   *\n   * @returns {Object} - a JSONifiable object representing the return value of\n   * the script\n   */\n  async executeDriverScript(\n    next,\n    driver,\n    script,\n    scriptType = 'webdriverio',\n    timeoutMs = DEFAULT_SCRIPT_TIMEOUT_MS\n  ) {\n    if (!driver.isFeatureEnabled(FEAT_FLAG)) {\n      throw new Error(\n        `Execute driver script functionality is not available ` +\n          `unless server is started with --allow-insecure including ` +\n          `the '${FEAT_FLAG}' flag, e.g., --allow-insecure=${FEAT_FLAG}`\n      );\n    }\n\n    if (scriptType !== SCRIPT_TYPE_WDIO) {\n      throw new TypeError(`Only the '${SCRIPT_TYPE_WDIO}' script type is currently supported`);\n    }\n\n    if (!driver.serverHost || !driver.serverPort) {\n      throw new Error(\n        'Address or port of running server were not defined; this ' +\n          'is required. This is probably a programming error in the driver'\n      );\n    }\n\n    if (!_.isNumber(timeoutMs)) {\n      throw new TypeError('Timeout parameter must be a number');\n    }\n\n    const driverOpts = {\n      sessionId: driver.sessionId,\n      // Appium probably won't be behind ssl locally; if it ever is, might need to update this to\n      // provide a user configurable parameter\n      protocol: 'http',\n      hostname: driver.serverHost,\n      port: driver.serverPort,\n      path: driver.serverPath,\n      isW3C: true,\n      isMobile: true,\n      capabilities: driver.caps,\n    };\n    this.logger.info(\n      `Constructed webdriverio driver options; W3C mode is ${driverOpts.isW3C ? 'on' : 'off'}`\n    );\n\n    // fork the execution script as a child process\n    const childScript = require.resolve('./execute-child.js');\n    this.logger.info(`Forking process to run webdriver script as child using ${childScript}`);\n    const scriptProc = cp.fork(childScript);\n\n    // keep track of whether we have canceled the script timeout, so we can stop\n    // waiting for it and allow this process to finish gracefully\n    let timeoutCanceled = false;\n\n    try {\n      const timer = new timing.Timer();\n      timer.start();\n\n      // promise that deals with the result from the child process\n      const waitForResult = async () => {\n        const res = await new B((res) => {\n          scriptProc.on('message', res); // this is node IPC\n        });\n\n        this.logger.info(\n          'Received execute driver script result from child process, shutting it down'\n        );\n\n        if (res.error) {\n          throw new Error(res.error.message);\n        }\n\n        return res.success;\n      };\n\n      // promise that waits up to the timeout and throws an error if so, or does\n      // nothing if the timeout is canceled because we got a result from the\n      // child script\n      const waitForTimeout = async () => {\n        while (!timeoutCanceled && timer.getDuration().asMilliSeconds < timeoutMs) {\n          await B.delay(500);\n        }\n\n        if (timeoutCanceled) {\n          return;\n        }\n\n        throw new Error(\n          `Execute driver script timed out after ${timeoutMs}ms. ` +\n            `You can adjust this with the 'timeout' parameter.`\n        );\n      };\n\n      // now that the child script is alive, send it the data it needs to start\n      // running the driver script\n      this.logger.info('Sending driver and script data to child');\n      scriptProc.send({driverOpts, script, timeoutMs});\n\n      // and set up a race between the response from the child and the timeout\n      return await B.race([waitForResult(), waitForTimeout()]);\n    } catch (err) {\n      throw new Error(`Could not execute driver script. Original error was: ${err}`);\n    } finally {\n      // ensure we always cancel the timeout so that the timeout promise stops\n      // spinning and allows this process to die gracefully\n      timeoutCanceled = true;\n\n      if (scriptProc.connected) {\n        this.logger.info('Disconnecting from child proc');\n        scriptProc.disconnect();\n      }\n\n      if (scriptProc.exitCode === null) {\n        this.logger.info('Disconnecting from and killing driver script child proc');\n        scriptProc.kill();\n      } else {\n        this.logger.info('Script already ended on its own, no need to kill it');\n      }\n    }\n  }\n}\n\nexport {ExecuteDriverPlugin};\n"],"mappings":"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"}