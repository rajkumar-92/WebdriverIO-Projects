{"version":3,"file":"execute-child.js","names":["log","logger","getLogger","send","W3C_ELEMENT_KEY","util","W3C_WEB_ELEMENT_IDENTIFIER","MJSONWP_ELEMENT_KEY","runScript","driverOpts","script","timeoutMs","_","isNumber","TypeError","logLevels","logs","consoleFns","level","logMsgs","push","driver","attach","fullScript","buildScript","info","vmCtx","NodeVM","timeout","vmFn","run","result","B","coerceScriptResult","obj","JSON","parse","stringify","e","warn","res","isPlainObject","key","Object","keys","isArray","map","main","success","error","message","stack","require","module","isFunction","process","promisify","context","on"],"sources":["../../lib/execute-child.js"],"sourcesContent":["import _ from 'lodash';\nimport B from 'bluebird';\nimport {NodeVM} from 'vm2';\nimport {logger, util} from 'appium/support';\nimport {attach} from 'webdriverio';\n\nconst log = logger.getLogger('ExecuteDriver Child');\nlet send;\n\n// duplicate defining these keys here so we don't need to re-load a huge appium\n// dependency tree into memory just to run a wdio script\nexport const W3C_ELEMENT_KEY = util.W3C_WEB_ELEMENT_IDENTIFIER;\nexport const MJSONWP_ELEMENT_KEY = 'ELEMENT';\n\nasync function runScript(driverOpts, script, timeoutMs) {\n  if (!_.isNumber(timeoutMs)) {\n    throw new TypeError('Timeout parameter must be a number');\n  }\n\n  // set up fake logger\n  const logLevels = ['error', 'warn', 'log'];\n  const logs = {};\n  const consoleFns = {};\n  for (const level of logLevels) {\n    logs[level] = [];\n    consoleFns[level] = (...logMsgs) => logs[level].push(...logMsgs);\n  }\n\n  const driver = await attach(driverOpts);\n\n  const fullScript = buildScript(script);\n\n  log.info('Running driver script in Node vm');\n\n  const vmCtx = new NodeVM({timeout: timeoutMs});\n  const vmFn = vmCtx.run(fullScript);\n\n  // run the driver script, giving user access to the driver object, a fake\n  // console logger, and a promise library\n  let result = await vmFn(driver, consoleFns, B);\n\n  result = coerceScriptResult(result);\n  log.info('Successfully ensured driver script result is appropriate type for return');\n  return {result, logs};\n}\n\n/**\n * Embed a user-generated script inside a method which takes only the\n * predetermined objects we specify\n *\n * @param {string} script - the javascript to execute\n *\n * @return {string} - the full script to execute\n */\nfunction buildScript(script) {\n  return `module.exports = async function execute (driver, console, Promise) {\n    ${script}\n  }`;\n}\n\n/**\n * We can get any manner of crazy thing back from a vm executing untrusted\n * code. We might also get WebdriverIO objects that aren't suitable for JSON\n * response. So make sure we convert the things we know about to their\n * appropriate response format, and squash other weird things.\n *\n * @param {Object} obj - object to convert and sanitize\n *\n * @return {Object} - safely converted object\n */\nfunction coerceScriptResult(obj) {\n  // first ensure obj is of a type that can be JSON encoded safely. This will\n  // get rid of custom objects, functions, etc... and turn them into POJOs\n  try {\n    obj = JSON.parse(JSON.stringify(obj));\n  } catch (e) {\n    log.warn(\n      'Could not convert executeDriverScript to safe response!' +\n        `Result was: ${JSON.stringify(obj)}. Will make it null`\n    );\n    return null;\n  }\n\n  let res;\n\n  // now we begin our recursive case options\n  if (_.isPlainObject(obj)) {\n    // if we have an object, it's either an element object or something else\n    // webdriverio has no monadic object types other than element and driver,\n    // and we don't want to allow special casing return of driver\n    res = {};\n\n    if (obj[MJSONWP_ELEMENT_KEY] || obj[W3C_ELEMENT_KEY]) {\n      // if it's an element object, clear out anything that's not the key, and then return the\n      // object. Note that if the element object contains only one element key type (MJSONWP or\n      // W3C), keep it that way in our response. But if the element contains both key types\n      // (because the client is being backwards compatible) then keep both keys in our response as\n      // well.\n      if (obj[MJSONWP_ELEMENT_KEY]) {\n        res[MJSONWP_ELEMENT_KEY] = obj[MJSONWP_ELEMENT_KEY];\n      }\n\n      if (obj[W3C_ELEMENT_KEY]) {\n        res[W3C_ELEMENT_KEY] = obj[W3C_ELEMENT_KEY];\n      }\n      return res;\n    }\n\n    // otherwise, recurse into the object\n    for (const key of Object.keys(obj)) {\n      res[key] = coerceScriptResult(obj[key]);\n    }\n    return res;\n  }\n\n  // also handle arrays\n  if (_.isArray(obj)) {\n    return obj.map(coerceScriptResult);\n  }\n\n  // base case, if it's not an object or array, return straightaway\n  return obj;\n}\n\nasync function main(driverOpts, script, timeoutMs) {\n  let res;\n  try {\n    res = {success: await runScript(driverOpts, script, timeoutMs)};\n  } catch (error) {\n    res = {error: {message: error.message, stack: error.stack}};\n  }\n  await send(res);\n}\n\n// ensure we're running this script in IPC mode\nif (require.main === module && _.isFunction(process.send)) {\n  send = B.promisify(process.send, {context: process});\n  log.info('Running driver execution in child process');\n  process.on('message', ({driverOpts, script, timeoutMs}) => {\n    log.info('Parameters received from parent process');\n    main(driverOpts, script, timeoutMs);\n  });\n}\n"],"mappings":"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"}